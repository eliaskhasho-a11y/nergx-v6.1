<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MergX v8.16 ‚Äî Economy Core</title>
<style>
  :root{
    --bg: #f5f7fb;
    --glass: rgba(255,255,255,0.68);
    --frost: rgba(255,255,255,0.45);
    --text:#0f172a;
    --muted:#475569;
    --primary:#1f9dff; /* bl√• */
    --accent:#00d2c6;  /* turkos */
    --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    --shadow: 0 10px 30px rgba(15,23,42,0.08);
    --radius:16px;
    --gap:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    color:var(--text);
    background:
      radial-gradient(1200px 800px at 10% -10%, #e6f3ff 0%, transparent 60%),
      radial-gradient(1000px 700px at 110% 10%, #e8fff9 0%, transparent 55%),
      var(--bg);
  }
  .app{
    display:grid; grid-template-columns: 260px 1fr; min-height:100vh;
  }
  aside{
    position:sticky; top:0; height:100vh; padding:20px;
    backdrop-filter: blur(16px);
    background: var(--glass);
    box-shadow: var(--shadow);
    border-right:1px solid rgba(0,0,0,.04);
  }
  .brand{display:flex; align-items:center; gap:10px; margin-bottom:18px}
  .logo{
    width:32px; height:32px; border-radius:10px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    box-shadow: 0 6px 16px rgba(31,157,255,.25);
  }
  .brand b{font-size:16px}
  nav a{
    display:flex; gap:10px; align-items:center;
    padding:10px 12px; margin:4px 0; border-radius:12px;
    color:var(--muted); text-decoration:none; font-weight:600;
  }
  nav a.active, nav a:hover{
    color:var(--text);
    background: linear-gradient(180deg, var(--glass), var(--frost));
    box-shadow: var(--shadow);
  }
  main{
    padding:22px; display:flex; flex-direction:column; gap:var(--gap);
  }
  header.top{
    display:flex; align-items:center; gap:12px; justify-content:space-between;
  }
  .search{
    flex:1; display:flex; align-items:center; gap:10px;
    background: var(--glass); padding:10px 12px; border-radius:12px;
    backdrop-filter: blur(10px); border:1px solid rgba(0,0,0,.05);
  }
  .search input{flex:1; border:0; background:transparent; outline:0; font-size:14px}
  .badges{display:flex; align-items:center; gap:10px}
  .badge{
    position:relative; width:38px; height:38px; display:grid; place-items:center;
    background: var(--glass); border-radius:12px; border:1px solid rgba(0,0,0,.06)
  }
  .badge::after{
    content: attr(data-count);
    position:absolute; top:-6px; right:-4px;
    background:#ef4444; color:#fff; font-size:11px; font-weight:700;
    padding:2px 6px; border-radius:999px; min-width:18px; text-align:center;
    box-shadow: 0 4px 10px rgba(239,68,68,.35);
  }
  .grid{
    display:grid; gap:var(--gap);
  }
  .grid.cols-4{grid-template-columns: repeat(4, minmax(0,1fr))}
  .grid.cols-3{grid-template-columns: repeat(3, minmax(0,1fr))}
  .grid.cols-2{grid-template-columns: repeat(2, minmax(0,1fr))}
  @media (max-width:1100px){ .grid.cols-4{grid-template-columns: repeat(2,1fr)} }
  @media (max-width:700px){ .app{grid-template-columns: 1fr} aside{position:static; height:auto} .grid.cols-3,.grid.cols-4{grid-template-columns:1fr} }

  .card{
    background: linear-gradient(180deg, var(--glass), var(--frost));
    border:1px solid rgba(0,0,0,.06);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(12px);
  }
  .card.h{padding:16px 16px}
  .stat{
    padding:16px; cursor:pointer; position:relative; overflow:hidden;
    transition: transform .15s ease;
  }
  .stat:hover{ transform: translateY(-2px) }
  .stat small{color:var(--muted); font-weight:600}
  .stat .v{display:flex; align-items:baseline; gap:8px; margin-top:6px}
  .stat .v b{font-size:24px}
  .pill{
    font-size:12px; padding:2px 8px; border-radius:999px; font-weight:700;
  }
  .up{ background: rgba(16,185,129,.1); color:#065f46; }
  .down{ background: rgba(239,68,68,.12); color:#7f1d1d; }

  .table{width:100%; border-collapse:collapse; font-size:14px}
  .table th, .table td{padding:10px 12px; border-bottom:1px solid rgba(0,0,0,.06)}
  .table th{ text-align:left; color:var(--muted); font-weight:700}
  .row-actions{display:flex; gap:8px}
  .btn{
    appearance:none; border:0; border-radius:12px; padding:10px 12px; font-weight:700;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color:#fff; box-shadow: 0 8px 20px rgba(31,157,255,.25); cursor:pointer;
  }
  .btn.ghost{
    background: var(--glass); color:var(--text); border:1px solid rgba(0,0,0,.06)
  }
  .btn.warn{ background: linear-gradient(135deg, #ff7a7a, #ef4444) }
  .btn.ok{ background: linear-gradient(135deg, #34d399, #10b981) }

  /* Modal */
  .modal{
    position:fixed; inset:0; display:none; place-items:center; z-index:1000;
  }
  .modal.open{ display:grid; }
  .backdrop{position:absolute; inset:0; background: rgba(2,6,23,.35); backdrop-filter: blur(4px);}
  .sheet{
    position:relative; width:min(980px, 92vw); max-height:86vh; overflow:auto;
    background: linear-gradient(180deg, var(--glass), var(--frost));
    border:1px solid rgba(0,0,0,.07); border-radius:20px; padding:18px;
    box-shadow: var(--shadow);
  }
  .sheet h3{margin:4px 0 12px 0}
  .form{display:grid; gap:12px}
  .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
  .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px}
  label{font-weight:700; font-size:12px; color:var(--muted)}
  input, select, textarea{
    width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.08);
    background: rgba(255,255,255,.7); outline: none;
  }
  textarea{min-height:80px; resize:vertical}
  .muted{color:var(--muted)}
  .right{display:flex; justify-content:flex-end; gap:8px}
  .section-title{display:flex; align-items:center; justify-content:space-between; padding:12px 16px}
  .chip{padding:6px 10px; border-radius:999px; background:rgba(0,0,0,.05); font-weight:700; color:var(--muted); font-size:12px}
  .flex{display:flex; gap:10px; align-items:center}
  .divider{height:1px; background: rgba(0,0,0,.06); margin:10px 0}
  .hint{font-size:12px; color:var(--muted)}
  .aiBox{
    margin-top:10px; padding:12px; border-radius:12px;
    background: linear-gradient(180deg, rgba(31,157,255,.08), rgba(0,210,198,.08));
    border:1px solid rgba(31,157,255,.15);
  }
  .hidden{display:none !important}
  .kpi-grid{display:grid; gap:16px; grid-template-columns: repeat(4, minmax(0,1fr))}
  @media (max-width:1100px){ .kpi-grid{grid-template-columns: repeat(2,1fr)} }
  @media (max-width:700px){ .kpi-grid{grid-template-columns: 1fr} }
</style>
</head>
<body>
<div class="app">
  <aside>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <b>MergX Admin</b><br>
        <small class="muted">v8.16 Economy Core</small>
      </div>
    </div>
    <nav id="nav">
      <a href="#dashboard" data-route="dashboard" class="active">üè† √ñversikt</a>
      <a href="#orders" data-route="orders">üßæ Order & Fakturor</a>
      <a href="#customers" data-route="customers">üë• Kunder</a>
      <a href="#inventory" data-route="inventory">üì¶ Inventarie</a>
      <a href="#employees" data-route="employees">üë§ Anst√§llda</a>
      <a href="#files" data-route="files">üóÇÔ∏è Filer & Kvitton</a>
      <a href="#settings" data-route="settings">‚öôÔ∏è Inst√§llningar</a>
    </nav>
  </aside>

  <main>
    <header class="top">
      <div class="search">
        üîé <input id="globalSearch" placeholder="S√∂k i MergX‚Ä¶ (kunder, order, produkter)">
      </div>
      <div class="badges">
        <div class="badge" id="notifyBadge" data-count="3">üîî</div>
        <div class="badge" title="AI Coach">ü§ñ</div>
      </div>
    </header>

    <!-- DASHBOARD -->
    <section id="page-dashboard" class="page">
      <div class="grid cols-4">
        <div class="card stat" onclick="openInsight('sales')">
          <small>Oms√§ttning idag</small>
          <div class="v"><b id="kpiSales">‚Äî</b><span class="pill up" id="kpiSalesDelta">+0%</span></div>
        </div>
        <div class="card stat" onclick="openInsight('orders')">
          <small>Order idag</small>
          <div class="v"><b id="kpiOrders">‚Äî</b><span class="pill up" id="kpiOrdersDelta">+0%</span></div>
        </div>
        <div class="card stat" onclick="openInsight('costs')">
          <small>Kostnader</small>
          <div class="v"><b id="kpiCosts">‚Äî</b><span class="pill down" id="kpiCostsDelta">-0%</span></div>
        </div>
        <div class="card stat" onclick="openInsight('margin')">
          <small>Bruttomarginal</small>
          <div class="v"><b id="kpiMargin">‚Äî</b><span class="pill up" id="kpiMarginDelta">+0%</span></div>
        </div>
      </div>

      <div class="grid cols-2">
        <div class="card h">
          <div class="section-title">
            <b>Senaste order</b>
            <button class="btn ghost" onclick="openOrderModal()">+ Skapa order</button>
          </div>
          <table class="table" id="recentOrdersTbl">
            <thead><tr><th>#</th><th>Kund</th><th>Summa</th><th>Status</th><th>Tid</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card h">
          <div class="section-title">
            <b>AI-karta (mock)</b>
            <span class="chip">Ask AI</span>
          </div>
          <div class="hint">Visar n√§rliggande butiker (mock) och f√∂reslagen rutt i n√§sta version.</div>
          <div class="aiBox" id="mapAiBox">
            F√∂rslag: Bes√∂k <b>Elon Kista</b> ‚Üí <b>Power Solna</b> ‚Üí <b>Mekonomen Bromma</b>. Total ca 43 min. <br/>
            L√§gg notis: ‚ÄúElon Kista vill k√∂pa om 20 dagar‚Äù.
          </div>
        </div>
      </div>
    </section>

    <!-- ORDERS -->
    <section id="page-orders" class="page hidden">
      <div class="card h">
        <div class="section-title">
          <b>Order & Fakturor</b>
          <div class="flex">
            <button class="btn ghost" onclick="openOrderModal()">+ Ny order</button>
          </div>
        </div>
        <table class="table" id="ordersTbl">
          <thead>
            <tr><th>#</th><th>Kund</th><th>Rader</th><th>Summa</th><th>Status</th><th>√Ötg√§rder</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- CUSTOMERS -->
    <section id="page-customers" class="page hidden">
      <div class="card h">
        <div class="section-title">
          <b>Kunder</b>
          <div class="flex"><button class="btn ghost" onclick="openCustomerModal()">+ Ny kund</button></div>
        </div>
        <table class="table" id="customersTbl">
          <thead>
            <tr><th>F√∂retag</th><th>Kontakt</th><th>Telefon</th><th>E-post</th><th>√Ötg√§rder</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- INVENTORY -->
    <section id="page-inventory" class="page hidden">
      <div class="card h">
        <div class="section-title">
          <b>Inventarie</b>
          <div class="flex"><button class="btn ghost" onclick="openProductModal()">+ Ny produkt</button></div>
        </div>
        <table class="table" id="inventoryTbl">
          <thead>
          <tr><th>Artikelnummer</th><th>Namn</th><th>Typ</th><th>Antal</th><th>Pris</th><th>√Ötg√§rder</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- EMPLOYEES -->
    <section id="page-employees" class="page hidden">
      <div class="card h">
        <div class="section-title">
          <b>Anst√§llda</b>
          <div class="flex"><button class="btn ghost" onclick="openEmployeeModal()">+ Ny anst√§lld</button></div>
        </div>
        <table class="table" id="employeesTbl">
          <thead>
          <tr><th>Namn</th><th>Roll</th><th>Telefon</th><th>E-post</th><th>√Ötg√§rder</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- FILES -->
    <section id="page-files" class="page hidden">
      <div class="card h">
        <div class="section-title">
          <b>Filer & Kvitton</b>
          <div class="flex"><button class="btn ghost" onclick="document.getElementById('fileInput').click()">+ Ladda upp</button></div>
        </div>
        <input id="fileInput" type="file" class="hidden" multiple onchange="handleFiles(this.files)" />
        <table class="table" id="filesTbl"><thead><tr><th>Namn</th><th>Typ</th><th>Storlek</th><th>√Ötg√§rder</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="page-settings" class="page hidden">
      <div class="card h">
        <div class="section-title"><b>F√∂retagsuppgifter</b><span class="hint">Anv√§nds p√• fakturor & meddelanden</span></div>
        <div class="form">
          <div class="row">
            <div>
              <label>F√∂retagsnamn</label>
              <input id="s_name" placeholder="MergX AB" />
            </div>
            <div>
              <label>Organisationsnummer</label>
              <input id="s_org" placeholder="559999-XXXX" />
            </div>
          </div>
          <div class="row3">
            <div><label>Momsnr (VAT)</label><input id="s_vat" placeholder="SE559999XXXX01"/></div>
            <div><label>Bankgiro / IBAN</label><input id="s_iban" placeholder="SE.. / BG.."/></div>
            <div><label>SWIFT</label><input id="s_swift" placeholder="SWEDSESS"/></div>
          </div>
          <div class="row3">
            <div><label>Adress</label><input id="s_addr" placeholder="Gatan 1"/></div>
            <div><label>Postnr</label><input id="s_zip" placeholder="111 22"/></div>
            <div><label>Ort</label><input id="s_city" placeholder="Stockholm"/></div>
          </div>
          <div class="row3">
            <div><label>Telefon</label><input id="s_phone" placeholder="+46‚Ä¶"/></div>
            <div><label>E-post</label><input id="s_email" placeholder="info@dittbolag.se"/></div>
            <div><label>Webbplats</label><input id="s_web" placeholder="https://"/></div>
          </div>
          <div class="row">
            <div><label>Fakturaprefix</label><input id="s_prefix" value="M-" /></div>
            <div><label>Signatur (namn, titel)</label><input id="s_sign" placeholder="Elias Khasho, VD" /></div>
          </div>
          <div class="right">
            <button class="btn" onclick="saveSettings()">Spara</button>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- MODALS -->

<!-- KPI Insight -->
<div class="modal" id="insightModal">
  <div class="backdrop" onclick="closeModal('insightModal')"></div>
  <div class="sheet">
    <h3 id="insightTitle">AI-insikt</h3>
    <div class="divider"></div>
    <div id="insightBody" class="muted">Laddar‚Ä¶</div>
    <div class="aiBox" style="margin-top:12px">
      üß† <b>AI Coach:</b>
      <div id="insightCoach">Trendar +6.2% mot f√∂reg√•ende vecka. Vill du skapa en prognos?</div>
    </div>
    <div class="right" style="margin-top:10px">
      <button class="btn ghost" onclick="closeModal('insightModal')">St√§ng</button>
      <button class="btn">Skapa AI-rapport (mock)</button>
    </div>
  </div>
</div>

<!-- Create/Edit Order -->
<div class="modal" id="orderModal">
  <div class="backdrop" onclick="closeModal('orderModal')"></div>
  <div class="sheet">
    <h3>Skapa order</h3>
    <div class="form">
      <div class="row">
        <div>
          <label>Kund</label>
          <select id="ord_customer"></select>
        </div>
        <div>
          <label>Betalvillkor (dagar)</label>
          <select id="ord_terms">
            <option>10</option><option selected>30</option><option>45</option><option>60</option>
          </select>
        </div>
      </div>

      <div class="card h">
        <div class="section-title">
          <b>Produktrader</b>
          <button class="btn ghost" onclick="addOrderRow()">+ L√§gg till rad</button>
        </div>
        <div id="orderRows"></div>
      </div>

      <div class="row3">
        <div>
          <label>Moms (%)</label>
          <input id="ord_vat" type="number" value="25" oninput="recalcOrder()" />
        </div>
        <div>
          <label>Delsumma</label>
          <input id="ord_sub" disabled />
        </div>
        <div>
          <label>Att betala</label>
          <input id="ord_total" disabled />
        </div>
      </div>

      <div class="aiBox">
        üß† <b>AI-f√∂rslag:</b> Kunden k√∂per ofta USB-C 60W + Lightning 27W i paket om 10 st. Vill du l√§gga till?
        <div class="right" style="margin-top:8px"><button class="btn ghost" onclick="applyAiBundle()">L√§gg till paket</button></div>
      </div>

      <div class="right">
        <button class="btn ghost" onclick="closeModal('orderModal')">Avbryt</button>
        <button class="btn ok" onclick="saveOrder()">Spara + Skapa faktura</button>
      </div>
    </div>
  </div>
</div>

<!-- Invoice Preview / Print -->
<div class="modal" id="invoiceModal">
  <div class="backdrop" onclick="closeModal('invoiceModal')"></div>
  <div class="sheet" id="invoiceSheet">
    <h3>Faktura <span id="invNumber"></span></h3>
    <div class="divider"></div>
    <div class="row">
      <div>
        <b id="invCompany">MergX AB</b><br>
        <span id="invAddr" class="muted">Adress, Postnr Ort</span><br>
        <span id="invOrg" class="muted">Org.nr ‚Ä¢ VAT</span><br>
        <span id="invBank" class="muted">IBAN/BG</span>
      </div>
      <div>
        <b>Kund</b><br>
        <span id="invCustName"></span><br>
        <span id="invCustEmail" class="muted"></span><br>
        <span id="invCustPhone" class="muted"></span>
      </div>
    </div>
    <div class="divider"></div>
    <table class="table" id="invLines"><thead>
      <tr><th>Artikel</th><th>Antal</th><th>√†-pris</th><th>Summa</th></tr>
    </thead><tbody></tbody></table>
    <div class="row3" style="margin-top:10px">
      <div></div>
      <div>
        <div class="muted">Delsumma</div>
        <div id="invSub"></div>
        <div class="muted" style="margin-top:6px">Moms</div>
        <div id="invVat"></div>
      </div>
      <div>
        <div class="muted">Att betala</div>
        <div id="invTotal" style="font-weight:800; font-size:18px"></div>
      </div>
    </div>
    <div class="divider"></div>
    <div class="right">
      <button class="btn ghost" onclick="openMessageModal()">Meddelande till kund</button>
      <button class="btn" onclick="printInvoice()">Skriv ut / Spara PDF</button>
    </div>
  </div>
</div>

<!-- Message to Customer -->
<div class="modal" id="messageModal">
  <div class="backdrop" onclick="closeModal('messageModal')"></div>
  <div class="sheet">
    <h3>Skicka meddelande till kund</h3>
    <div class="form">
      <div class="row3">
        <button class="btn ghost" onclick="sendWhatsApp()">WhatsApp</button>
        <button class="btn ghost" onclick="sendSMS()">SMS</button>
        <button class="btn ghost" onclick="sendEmail()">E-post</button>
      </div>
      <label>Meddelande</label>
      <textarea id="msgText">Hej! Er faktura √§r skapad. √Öterkom g√§rna vid fr√•gor.</textarea>
      <div class="right"><button class="btn" onclick="closeModal('messageModal')">Klar</button></div>
    </div>
  </div>
</div>

<!-- Customer / Product / Employee basic modals (quick add) -->
<div class="modal" id="customerModal">
  <div class="backdrop" onclick="closeModal('customerModal')"></div>
  <div class="sheet">
    <h3>Ny kund</h3>
    <div class="form">
      <div class="row">
        <div><label>F√∂retag</label><input id="c_name"/></div>
        <div><label>Organisationsnummer</label><input id="c_org"/></div>
      </div>
      <div class="row">
        <div><label>Kontaktperson</label><input id="c_contact"/></div>
        <div><label>E-post</label><input id="c_email"/></div>
      </div>
      <div class="row">
        <div><label>Telefon</label><input id="c_phone"/></div>
        <div><label>Adress</label><input id="c_addr"/></div>
      </div>
      <div class="right">
        <button class="btn ghost" onclick="closeModal('customerModal')">Avbryt</button>
        <button class="btn ok" onclick="saveCustomer()">Spara</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="productModal">
  <div class="backdrop" onclick="closeModal('productModal')"></div>
  <div class="sheet">
    <h3>Ny produkt</h3>
    <div class="form">
      <div class="row3">
        <div><label>Artikelnummer</label><input id="p_sku"/></div>
        <div><label>Namn</label><input id="p_name"/></div>
        <div><label>Typ</label><input id="p_type" placeholder="Kabel/Charger‚Ä¶"/></div>
      </div>
      <div class="row3">
        <div><label>Antal</label><input id="p_qty" type="number" value="0"/></div>
        <div><label>Pris</label><input id="p_price" type="number" value="199"/></div>
        <div><label>√ñvrigt</label><input id="p_note"/></div>
      </div>
      <div class="right">
        <button class="btn ghost" onclick="closeModal('productModal')">Avbryt</button>
        <button class="btn ok" onclick="saveProduct()">Spara</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="employeeModal">
  <div class="backdrop" onclick="closeModal('employeeModal')"></div>
  <div class="sheet">
    <h3>Ny anst√§lld</h3>
    <div class="form">
      <div class="row3">
        <div><label>Namn</label><input id="e_name"/></div>
        <div><label>Roll</label><input id="e_role" placeholder="S√§ljare/Manager‚Ä¶"/></div>
        <div><label>Telefon</label><input id="e_phone"/></div>
      </div>
      <div class="row">
        <div><label>E-post</label><input id="e_email"/></div>
        <div><label>Typ</label>
          <select id="e_type">
            <option>Heltid</option><option>Delstid</option><option>Provanst√§lld</option>
          </select>
        </div>
      </div>
      <div class="right">
        <button class="btn ghost" onclick="closeModal('employeeModal')">Avbryt</button>
        <button class="btn ok" onclick="saveEmployee()">Spara</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------------------- MOCK STORAGE ---------------------- */
const store = {
  customers: JSON.parse(localStorage.getItem('mx_customers')||'[]'),
  products:  JSON.parse(localStorage.getItem('mx_products')||'[]'),
  employees: JSON.parse(localStorage.getItem('mx_employees')||'[]'),
  orders:    JSON.parse(localStorage.getItem('mx_orders')||'[]'),
  files:     JSON.parse(localStorage.getItem('mx_files')||'[]'),
  settings:  JSON.parse(localStorage.getItem('mx_settings')||'{}'),
};
if(store.customers.length===0){
  store.customers = [
    {id:1,name:"Elon Kista", contact:"Sara Nilsson", phone:"+46701234567", email:"sara@elon.se", addr:"Kistag√•ngen 15, Kista", org:"556677-8899"},
    {id:2,name:"Power Solna", contact:"Jonas Berg", phone:"+46705554433", email:"jonas@power.se", addr:"Solnav√§gen 3", org:"559100-2222"}
  ];
}
if(store.products.length===0){
  store.products = [
    {id:1, sku:"AC-USB-C-60W", name:"USB-C till USB-C 60W", type:"Kabel", qty:120, price:199},
    {id:2, sku:"AC-LTN-27W", name:"USB-C till Lightning 27W", type:"Kabel", qty:80, price:249},
    {id:3, sku:"AC-CCD-60W", name:"Bil-laddare 2√ó30W", type:"Laddare", qty:45, price:399},
  ];
}
saveAll();

function saveAll(){
  localStorage.setItem('mx_customers', JSON.stringify(store.customers));
  localStorage.setItem('mx_products', JSON.stringify(store.products));
  localStorage.setItem('mx_employees', JSON.stringify(store.employees));
  localStorage.setItem('mx_orders', JSON.stringify(store.orders));
  localStorage.setItem('mx_files', JSON.stringify(store.files));
  localStorage.setItem('mx_settings', JSON.stringify(store.settings));
}

/* ---------------------- ROUTING ---------------------- */
const pages = [...document.querySelectorAll('.page')];
function route(){
  const hash = location.hash.replace('#','') || 'dashboard';
  document.querySelectorAll('nav a').forEach(a=>a.classList.toggle('active', a.dataset.route===hash));
  pages.forEach(p=>p.classList.add('hidden'));
  const el = document.getElementById('page-'+hash);
  if(el) el.classList.remove('hidden');
  render();
}
window.addEventListener('hashchange', route);

/* ---------------------- RENDERERS ---------------------- */
function render(){
  // KPIs mock
  document.getElementById('kpiSales').textContent = currency(sumOrdersToday());
  document.getElementById('kpiSalesDelta').textContent = "+5.1%";
  document.getElementById('kpiOrders').textContent = countOrdersToday()+" st";
  document.getElementById('kpiOrdersDelta').textContent = "+2";
  document.getElementById('kpiCosts').textContent = "‚Äî";
  document.getElementById('kpiMargin').textContent = "42%";

  // Recent orders (dashboard)
  const tbodyR = document.querySelector('#recentOrdersTbl tbody');
  tbodyR.innerHTML = "";
  store.orders.slice(-5).reverse().forEach(o=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${o.number}</td><td>${custName(o.customerId)}</td>
      <td>${currency(o.total)}</td><td>${o.status}</td><td>${new Date(o.createdAt).toLocaleString()}</td>`;
    tbodyR.appendChild(tr);
  });

  // Orders page
  const tbody = document.querySelector('#ordersTbl tbody');
  if(tbody){
    tbody.innerHTML = "";
    store.orders.slice().reverse().forEach(o=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${o.number}</td>
        <td>${custName(o.customerId)}</td>
        <td>${o.lines.length}</td>
        <td>${currency(o.total)}</td>
        <td>${o.status}</td>
        <td class="row-actions">
          <button class="btn ghost" onclick="previewInvoice('${o.id}')">üëÅÔ∏è F√∂rhandsvisa</button>
          <button class="btn ghost" onclick="openMessageModal('${o.id}')">üí¨ Medd</button>
          <button class="btn ghost" onclick="createLabel('${o.id}')">üì¶ Etikett</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  // Customers
  const ctb = document.querySelector('#customersTbl tbody');
  if(ctb){
    ctb.innerHTML = "";
    store.customers.forEach(c=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><a href="javascript:void(0)" onclick="openCustomerCard(${c.id})"><b>${c.name}</b></a></td>
        <td>${c.contact||'-'}</td><td>${c.phone||'-'}</td><td>${c.email||'-'}</td>
        <td class="row-actions">
          <button class="btn ghost" onclick="openOrderModal(${c.id})">üßæ Order</button>
          <button class="btn ghost" onclick="editCustomer(${c.id})">‚úèÔ∏è</button>
          <button class="btn warn" onclick="deleteCustomer(${c.id})">üóëÔ∏è</button>
        </td>`;
      ctb.appendChild(tr);
    });
  }

  // Inventory
  const itb = document.querySelector('#inventoryTbl tbody');
  if(itb){
    itb.innerHTML = "";
    store.products.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${p.sku}</td><td><a href="javascript:void(0)" onclick="openProductCard(${p.id})"><b>${p.name}</b></a></td>
        <td>${p.type||'-'}</td><td>${p.qty}</td><td>${currency(p.price)}</td>
        <td class="row-actions">
          <button class="btn ghost" onclick="editProduct(${p.id})">‚úèÔ∏è</button>
          <button class="btn warn" onclick="deleteProduct(${p.id})">üóëÔ∏è</button>
        </td>`;
      itb.appendChild(tr);
    });
  }

  // Employees
  const etb = document.querySelector('#employeesTbl tbody');
  if(etb){
    etb.innerHTML = "";
    store.employees.forEach(e=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${e.name}</td><td>${e.role||'-'}</td><td>${e.phone||'-'}</td><td>${e.email||'-'}</td>
        <td class="row-actions">
          <button class="btn ghost" onclick="editEmployee(${e.id})">‚úèÔ∏è</button>
          <button class="btn warn" onclick="deleteEmployee(${e.id})">üóëÔ∏è</button>
        </td>`;
      etb.appendChild(tr);
    });
  }

  // Files
  const ftb = document.querySelector('#filesTbl tbody');
  if(ftb){
    ftb.innerHTML = "";
    store.files.forEach(f=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${f.name}</td><td>${f.type}</td><td>${(f.size/1024|0)} kB</td>
        <td class="row-actions"><button class="btn ghost" onclick="downloadFile('${f.id}')">‚¨áÔ∏è</button></td>`;
      ftb.appendChild(tr);
    });
  }
}

/* ---------------------- HELPERS ---------------------- */
function currency(n){ return new Intl.NumberFormat('sv-SE',{style:'currency', currency:'SEK'}).format(n||0) }
function custName(id){ const c = store.customers.find(x=>x.id==id); return c?c.name:'‚Äî' }
function sumOrdersToday(){
  const today = new Date().toDateString();
  return store.orders.filter(o=>new Date(o.createdAt).toDateString()===today).reduce((s,o)=>s+o.total,0);
}
function countOrdersToday(){
  const today = new Date().toDateString();
  return store.orders.filter(o=>new Date(o.createdAt).toDateString()===today).length;
}

/* ---------------------- KPI INSIGHT ---------------------- */
function openInsight(kind){
  const titleMap = {sales:"Oms√§ttning idag",orders:"Order idag",costs:"Kostnader",margin:"Bruttomarginal"};
  document.getElementById('insightTitle').textContent = titleMap[kind] || "AI-insikt";
  const body = document.getElementById('insightBody');
  let text = "";
  if(kind==='sales') text = "F√∂rs√§ljning visar positiv trend, fr√§mst drivet av B2B-kunder i Stockholm.";
  if(kind==='orders') text = "Ordervolymen drivs av √•terkommande kunder. Rek. att kontakta 3 st som inte best√§llt p√• 30 dagar.";
  if(kind==='costs') text = "Kostnaderna stabila. St√∂rsta posten √§r logistik, h√§r finns -8% potential.";
  if(kind==='margin') text = "Marginalen st√§rks av l√§gre ink√∂pspris p√• kablar. Rek. kampanj p√• laddare.";
  body.textContent = text;
  openModal('insightModal');
}

/* ---------------------- ORDER FLOW ---------------------- */
function openOrderModal(customerId){
  // customers select
  const sel = document.getElementById('ord_customer');
  sel.innerHTML = store.customers.map(c=>`<option value="${c.id}" ${c.id==customerId?'selected':''}>${c.name}</option>`).join('');
  document.getElementById('ord_vat').value = 25;
  document.getElementById('orderRows').innerHTML = '';
  addOrderRow();
  recalcOrder();
  openModal('orderModal');
}
function addOrderRow(){
  const wrap = document.getElementById('orderRows');
  const idx = wrap.children.length;
  const row = document.createElement('div');
  row.className='row3';
  row.innerHTML = `
    <div>
      <label>Produkt</label>
      <select onchange="recalcOrder()" class="ord_prod">
        ${store.products.map(p=>`<option value="${p.id}">${p.name} (${p.sku})</option>`).join('')}
      </select>
    </div>
    <div>
      <label>Antal</label>
      <input type="number" value="1" class="ord_qty" oninput="recalcOrder()" />
    </div>
    <div>
      <label>√†-pris</label>
      <input type="number" value="${store.products[0]?.price||0}" class="ord_price" oninput="recalcOrder()" />
    </div>
  `;
  wrap.appendChild(row);
}
function recalcOrder(){
  const rows = [...document.querySelectorAll('#orderRows .row3')];
  let sub = 0;
  rows.forEach(r=>{
    const qty = Number(r.querySelector('.ord_qty').value||0);
    const price = Number(r.querySelector('.ord_price').value||0);
    sub += qty*price;
  });
  const vat = Number(document.getElementById('ord_vat').value||0);
  const total = sub * (1+vat/100);
  document.getElementById('ord_sub').value = currency(sub);
  document.getElementById('ord_total').value = currency(total);
}
function applyAiBundle(){
  // Add suggested bundle rows
  addOrderRow(); addOrderRow();
  const rows = [...document.querySelectorAll('#orderRows .row3')];
  rows.at(-2).querySelector('.ord_prod').value = store.products[0].id;
  rows.at(-2).querySelector('.ord_qty').value = 10;
  rows.at(-2).querySelector('.ord_price').value = store.products[0].price;
  rows.at(-1).querySelector('.ord_prod').value = store.products[1].id;
  rows.at(-1).querySelector('.ord_qty').value = 10;
  rows.at(-1).querySelector('.ord_price').value = store.products[1].price;
  recalcOrder();
}
function saveOrder(){
  // collect
  const customerId = Number(document.getElementById('ord_customer').value);
  const vat = Number(document.getElementById('ord_vat').value||0);
  const rows = [...document.querySelectorAll('#orderRows .row3')].map(r=>{
    const pid = Number(r.querySelector('.ord_prod').value);
    const qty = Number(r.querySelector('.ord_qty').value||0);
    const price = Number(r.querySelector('.ord_price').value||0);
    const prod = store.products.find(p=>p.id===pid);
    return {pid, sku:prod.sku, name:prod.name, qty, price, sum: qty*price};
  });
  const sub = rows.reduce((s,x)=>s+x.sum,0);
  const total = sub*(1+vat/100);

  const id = crypto.randomUUID();
  const num = (store.settings.prefix||'M-') + new Date().toISOString().slice(2,10).replaceAll('-','') + '-' + String(store.orders.length+1).padStart(3,'0');
  const order = {
    id, number:num, customerId, lines:rows, sub, vat, total, status:'Skapad', createdAt: new Date().toISOString()
  };
  store.orders.push(order); saveAll();
  closeModal('orderModal');
  render();
  previewInvoice(order.id);
}

function previewInvoice(orderId){
  const o = store.orders.find(x=>x.id===orderId) || store.orders.slice(-1)[0];
  if(!o) return;
  // Company
  const s = store.settings||{};
  document.getElementById('invNumber').textContent = o.number;
  document.getElementById('invCompany').textContent = s.name || 'Ditt bolag';
  document.getElementById('invAddr').textContent = [s.addr, s.zip, s.city].filter(Boolean).join(', ') || 'Adress, Postnr Ort';
  document.getElementById('invOrg').textContent = [s.org, s.vat].filter(Boolean).join(' ‚Ä¢ ') || 'Org.nr ‚Ä¢ VAT';
  document.getElementById('invBank').textContent = [s.iban].filter(Boolean).join(' ') || 'IBAN/BG';
  // Customer
  const c = store.customers.find(x=>x.id===o.customerId);
  document.getElementById('invCustName').textContent = c ? c.name : '';
  document.getElementById('invCustEmail').textContent = c?.email || '';
  document.getElementById('invCustPhone').textContent = c?.phone || '';
  // Lines
  const tb = document.querySelector('#invLines tbody');
  tb.innerHTML = '';
  o.lines.forEach(l=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${l.name} (${l.sku})</td><td>${l.qty}</td><td>${currency(l.price)}</td><td>${currency(l.sum)}</td>`;
    tb.appendChild(tr);
  });
  document.getElementById('invSub').textContent = currency(o.sub);
  document.getElementById('invVat').textContent = `${o.vat}%`;
  document.getElementById('invTotal').textContent = currency(o.total);
  openModal('invoiceModal');
}
function printInvoice(){ window.print(); }

/* ---------------------- MESSAGE / SHIPPING ---------------------- */
let currentOrderForMessage = null;
function openMessageModal(orderId){
  if(orderId) currentOrderForMessage = orderId;
  openModal('messageModal');
}
function sendWhatsApp(){
  const o = store.orders.find(x=>x.id===currentOrderForMessage) || store.orders.slice(-1)[0];
  const c = store.customers.find(x=>x.id===o.customerId);
  const txt = encodeURIComponent(document.getElementById('msgText').value || `Hej ${c?.contact||''}! Er faktura ${o.number} √§r skapad.`);
  const tel = (c?.phone||'').replaceAll(' ','');
  window.open(`https://wa.me/${tel}?text=${txt}`, '_blank');
}
function sendSMS(){
  const o = store.orders.find(x=>x.id===currentOrderForMessage) || store.orders.slice(-1)[0];
  const c = store.customers.find(x=>x.id===o.customerId);
  const txt = encodeURIComponent(document.getElementById('msgText').value || `Hej! Faktura ${o.number} √§r skapad.`);
  const tel = (c?.phone||'').replaceAll(' ','');
  window.open(`sms:${tel}?&body=${txt}`, '_self');
}
function sendEmail(){
  const o = store.orders.find(x=>x.id===currentOrderForMessage) || store.orders.slice(-1)[0];
  const c = store.customers.find(x=>x.id===o.customerId);
  const txt = encodeURIComponent(document.getElementById('msgText').value || `Hej! Faktura ${o.number} √§r skapad.`);
  window.open(`mailto:${c?.email||''}?subject=Faktura%20${o.number}&body=${txt}`,'_self');
}
function createLabel(orderId){
  const o = store.orders.find(x=>x.id===orderId);
  alert(`(Mock) Fraktetikett skapad f√∂r ${o.number}. N√§sta version: riktig PDF & Fraktjakt-API.`);
}

/* ---------------------- QUICK CRUD ---------------------- */
function openCustomerModal(){ openModal('customerModal'); }
function saveCustomer(){
  const c = {
    id: Date.now(),
    name: val('c_name'), org: val('c_org'), contact: val('c_contact'),
    email: val('c_email'), phone: val('c_phone'), addr: val('c_addr')
  };
  store.customers.push(c); saveAll(); closeModal('customerModal'); render();
}
function editCustomer(id){
  const c = store.customers.find(x=>x.id===id); if(!c) return;
  openCustomerModal();
  setVal('c_name', c.name); setVal('c_org', c.org); setVal('c_contact', c.contact);
  setVal('c_email', c.email); setVal('c_phone', c.phone); setVal('c_addr', c.addr);
  // override save to update
  const btn = document.querySelector('#customerModal .btn.ok');
  btn.onclick = ()=>{
    c.name = val('c_name'); c.org=val('c_org'); c.contact=val('c_contact');
    c.email=val('c_email'); c.phone=val('c_phone'); c.addr=val('c_addr');
    saveAll(); closeModal('customerModal'); render();
  };
}
function deleteCustomer(id){
  if(!confirm('Ta bort kunden?')) return;
  store.customers = store.customers.filter(x=>x.id!==id); saveAll(); render();
}

function openProductModal(){ openModal('productModal'); }
function saveProduct(){
  const p = {
    id: Date.now(), sku: val('p_sku'), name: val('p_name'), type: val('p_type'),
    qty: Number(val('p_qty')||0), price: Number(val('p_price')||0), note: val('p_note')
  };
  store.products.push(p); saveAll(); closeModal('productModal'); render();
}
function editProduct(id){
  const p = store.products.find(x=>x.id===id); if(!p) return;
  openProductModal();
  setVal('p_sku', p.sku); setVal('p_name', p.name); setVal('p_type', p.type);
  setVal('p_qty', p.qty); setVal('p_price', p.price); setVal('p_note', p.note||'');
  const btn = document.querySelector('#productModal .btn.ok');
  btn.onclick = ()=>{
    p.sku = val('p_sku'); p.name=val('p_name'); p.type=val('p_type');
    p.qty = Number(val('p_qty')||0); p.price=Number(val('p_price')||0); p.note=val('p_note');
    saveAll(); closeModal('productModal'); render();
  };
}
function deleteProduct(id){
  if(!confirm('Ta bort produkten?')) return;
  store.products = store.products.filter(x=>x.id!==id); saveAll(); render();
}

function openEmployeeModal(){ openModal('employeeModal'); }
function saveEmployee(){
  const e = {
    id: Date.now(), name: val('e_name'), role: val('e_role'),
    phone: val('e_phone'), email: val('e_email'), type: val('e_type')
  };
  store.employees.push(e); saveAll(); closeModal('employeeModal'); render();
}
function editEmployee(id){
  const e = store.employees.find(x=>x.id===id); if(!e) return;
  openEmployeeModal();
  setVal('e_name', e.name); setVal('e_role', e.role); setVal('e_phone', e.phone);
  setVal('e_email', e.email); setVal('e_type', e.type||'Heltid');
  const btn = document.querySelector('#employeeModal .btn.ok');
  btn.onclick = ()=>{
    e.name = val('e_name'); e.role=val('e_role'); e.phone=val('e_phone');
    e.email=val('e_email'); e.type=val('e_type');
    saveAll(); closeModal('employeeModal'); render();
  };
}
function deleteEmployee(id){
  if(!confirm('Ta bort anst√§lld?')) return;
  store.employees = store.employees.filter(x=>x.id!==id); saveAll(); render();
}

/* ---------------------- FILES ---------------------- */
function handleFiles(files){
  [...files].forEach(f=>{
    store.files.push({id: crypto.randomUUID(), name:f.name, type:f.type||'ok√§nd', size:f.size});
  });
  saveAll(); render();
}
function downloadFile(id){
  alert('(Mock) H√§mtar fil: ' + id);
}

/* ---------------------- SETTINGS ---------------------- */
function saveSettings(){
  store.settings = {
    name: val('s_name'), org: val('s_org'), vat: val('s_vat'), iban: val('s_iban'),
    swift: val('s_swift'), addr: val('s_addr'), zip: val('s_zip'), city: val('s_city'),
    phone: val('s_phone'), email: val('s_email'), web: val('s_web'),
    prefix: val('s_prefix')||'M-', sign: val('s_sign')
  };
  saveAll();
  alert('F√∂retagsuppgifter sparade.');
}

/* ---------------------- UTIL / UI ---------------------- */
function val(id){ return document.getElementById(id).value }
function setVal(id,v){ document.getElementById(id).value = v||'' }
function openModal(id){ document.getElementById(id).classList.add('open') }
function closeModal(id){ document.getElementById(id).classList.remove('open') }

/* ---------------------- INIT ---------------------- */
function mountSettingsForm(){
  const s = store.settings||{};
  setVal('s_name', s.name); setVal('s_org', s.org); setVal('s_vat', s.vat);
  setVal('s_iban', s.iban); setVal('s_swift', s.swift);
  setVal('s_addr', s.addr); setVal('s_zip', s.zip); setVal('s_city', s.city);
  setVal('s_phone', s.phone); setVal('s_email', s.email); setVal('s_web', s.web);
  setVal('s_prefix', s.prefix||'M-'); setVal('s_sign', s.sign);
}
route(); mountSettingsForm();
</script>
</body>
</html>
