<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MergX v8.18 ‚Äî Admin</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
<style>
  :root{
    --bg:#f6f8fb;
    --card:#ffffffcc;           /* glass */
    --glass-stroke:#e9edf3;
    --text:#101828;
    --muted:#667085;
    --primary:#2563eb;          /* bl√• pastell */
    --accent:#22c55e;           /* gr√∂n */
    --danger:#ef4444;
    --shadow: 0 10px 30px rgba(16,24,40,.06);
    --radius:16px;
    --gap:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:radial-gradient(1200px 600px at 20% -10%, #e9f0ff 0%, transparent 60%) , var(--bg);
    color:var(--text); font:15px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial;
  }

  /* Layout */
  .layout{display:grid; grid-template-columns: 260px 1fr; min-height:100dvh}
  aside{
    position:sticky; top:0; height:100dvh; padding:24px 16px; border-right:1px solid var(--glass-stroke);
    backdrop-filter:saturate(1.2) blur(6px); background:#ffffff7a;
  }
  .brand{display:flex; align-items:center; gap:10px; margin-bottom:20px}
  .brand .logo{
    width:28px;height:28px; border-radius:8px;
    background:linear-gradient(135deg,#4f46e5 0%, #06b6d4 70%); box-shadow:0 4px 14px rgba(79,70,229,.35);
  }
  .brand h1{font-size:16px; margin:0}
  .version{color:var(--muted); font-size:12px}

  nav{display:flex; flex-direction:column; gap:8px; margin-top:8px}
  .nav-item{
    display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; color:#111;
    text-decoration:none; cursor:pointer; transition:background .15s, transform .03s;
  }
  .nav-item:hover{background:#eef2ff}
  .nav-item.active{background:#e0ebff; color:#0b3aa6}
  .nav-item .dot{width:8px;height:8px;border-radius:999px;background:#c7d2fe}

  main{min-height:100dvh; display:flex; flex-direction:column}
  header{
    position:sticky; top:0; z-index:50; background:rgba(255,255,255,.75); backdrop-filter:blur(8px);
    border-bottom:1px solid var(--glass-stroke);
  }
  .bar{display:flex; align-items:center; gap:12px; padding:12px 18px}
  .search{
    flex:1; position:relative;
  }
  .search input{
    width:100%; padding:12px 44px; border-radius:12px; border:1px solid var(--glass-stroke); background:#fff;
    box-shadow:var(--shadow);
  }
  .search .icon{position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#98a2b3}
  .content{padding:20px; max-width:1400px; width:100%; margin-inline:auto; display:grid; gap:20px}

  /* Cards */
  .grid{display:grid; gap:20px}
  .grid.cols-4{grid-template-columns:repeat(4,1fr)}
  .grid.cols-2{grid-template-columns: 2fr 1fr}
  .grid.cols-3{grid-template-columns:1.3fr 1fr 1fr}
  .card{
    background:var(--card); border:1px solid var(--glass-stroke); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:16px; position:relative;
  }
  .card h3{margin:0 0 10px; font-size:14px; color:#344054}
  .kpi {display:flex; flex-direction:column; gap:8px}
  .kpi .value{font-size:28px; font-weight:700}
  .kpi .delta{display:inline-block; background:#e9fbe7; color:#15803d; padding:6px 10px; border-radius:999px; font-weight:600}
  .kpi .delta.down{background:#eef5ff; color:#1d4ed8}

  .btn, button{
    display:inline-flex; align-items:center; gap:8px; border:none; border-radius:10px; padding:9px 12px; cursor:pointer;
    background:#eef2ff; color:#0b3aa6; font-weight:600;
  }
  .btn.primary{background:var(--primary); color:#fff}
  .btn.ghost{background:transparent; border:1px solid var(--glass-stroke); color:#334155}
  .actions{position:absolute; right:12px; top:12px; display:flex; gap:8px}

  /* Table */
  table{width:100%; border-collapse: collapse}
  th,td{padding:10px 12px; border-bottom:1px solid #eef2f7; text-align:left; font-size:14px}
  th{color:#475467; font-weight:600}

  /* Map */
  #miniMap, #aiMap{height:280px; border-radius:12px; overflow:hidden}
  .map-actions{display:flex; gap:8px; margin-top:10px}

  /* Chat dock */
  .dock{
    position:fixed; right:20px; bottom:20px; width:340px; background:var(--card); border:1px solid var(--glass-stroke);
    border-radius:14px; box-shadow:var(--shadow); display:flex; flex-direction:column; overflow:hidden; z-index:40;
  }
  .dock-header{background:#eaf0ff; padding:10px 12px; font-weight:700}
  .dock-body{height:200px; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:8px}
  .msg{max-width:80%; padding:8px 10px; border-radius:10px}
  .msg.me{align-self:flex-end; background:#dbeafe}
  .msg.ai{align-self:flex-start; background:#f1f5f9}
  .dock-input{display:flex; gap:8px; padding:10px; border-top:1px solid var(--glass-stroke)}
  .dock-input input{flex:1; padding:10px 12px; border-radius:10px; border:1px solid var(--glass-stroke); background:#fff}

  /* Toast / overlay */
  .toast{position:fixed; inset:auto auto 20px 20px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; opacity:0; transform:translateY(10px); transition:.2s; z-index:60}
  .toast.show{opacity:1; transform:translateY(0)}
  .overlay{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; place-items:center; z-index:55}
  .overlay .panel{width:min(700px,90vw)}

  /* Responsive */
  @media (max-width: 1200px){
    .grid.cols-4{grid-template-columns:repeat(2,1fr)}
    .grid.cols-3{grid-template-columns:1fr}
    .grid.cols-2{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="layout">

  <!-- Sidebar -->
  <aside>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>MergX Admin</h1>
        <div class="version">v8.18 ‚Ä¢ Light + Glass</div>
      </div>
    </div>

    <nav id="sidebar"></nav>
  </aside>

  <!-- Main -->
  <main>
    <header>
      <div class="bar">
        <div class="search">
          <span class="icon">üîé</span>
          <input id="globalSearch" placeholder="S√∂k i MergX‚Ä¶ (kunder, order, produkter)" />
        </div>
        <button class="btn ghost" id="gotoDashboard">G√• till √ñversikt</button>
        <button class="btn ghost" title="Notiser">üîî <span id="badge" style="margin-left:6px;background:#ef4444;color:#fff;border-radius:999px;padding:2px 6px;font-weight:700;">3</span></button>
      </div>
    </header>

    <div class="content" id="view"></div>
  </main>
</div>

<!-- Dock Chat -->
<div class="dock" id="dock">
  <div class="dock-header">MergX Chatt & AI</div>
  <div class="dock-body" id="dockBody">
    <div class="msg ai">Hej! Jag bevakar KPI:er, lager och notiser. Fr√•ga mig vad som helst. üôå</div>
  </div>
  <div class="dock-input">
    <input id="dockInput" placeholder="Skriv meddelande‚Ä¶ (Enter skickar)" />
    <button class="btn" id="dockSend">Skicka</button>
  </div>
</div>

<!-- Overlay (expander / AI-analys) -->
<div class="overlay" id="overlay">
  <div class="panel card">
    <div class="actions"><button class="btn ghost" onclick="closeOverlay()">St√§ng ‚úï</button></div>
    <div id="overlayBody"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Vendor -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ------------------------------
   Router + Sidebar
--------------------------------*/
const routes = [
  { id:'dashboard', label:'√ñversikt', icon:'üè†', render: renderDashboard },
  { id:'orders', label:'Ordrar & fakturor', icon:'üßæ', render: renderOrders },
  { id:'customers', label:'Kunder (CRM)', icon:'üë•', render: renderCustomers },
  { id:'inventory', label:'Inventarie', icon:'üì¶', render: renderInventory },
  { id:'employees', label:'Anst√§llda', icon:'üßë‚Äçüíº', render: renderEmployees },
  { id:'files', label:'Filer & kvitton', icon:'üßæ', render: renderFiles },
  { id:'map', label:'AI-karta', icon:'üó∫Ô∏è', render: renderAIMap },
  { id:'chat', label:'Chatt', icon:'üí¨', render: renderChat },
  { id:'settings', label:'Inst√§llningar', icon:'‚öôÔ∏è', render: renderSettings },
];

const sidebarEl = document.getElementById('sidebar');
routes.forEach(r=>{
  const a = document.createElement('a');
  a.className='nav-item';
  a.dataset.route=r.id;
  a.innerHTML = `<span class="dot"></span><span>${r.icon}</span><span>${r.label}</span>`;
  a.onclick = () => navigate(r.id);
  sidebarEl.appendChild(a);
});

function setActive(route){
  [...sidebarEl.children].forEach(el=>el.classList.toggle('active', el.dataset.route===route));
}

function navigate(id){
  if(!id) id='dashboard';
  location.hash = '#/'+id;
  render();
}

window.addEventListener('hashchange', render);
document.getElementById('gotoDashboard').onclick = ()=>navigate('dashboard');

if(!location.hash) navigate('dashboard');  // auto default
else render();

function render(){
  const id = (location.hash.replace('#/','') || 'dashboard');
  const route = routes.find(r=>r.id===id) || routes[0];
  setActive(route.id);
  route.render();
}

/* ------------------------------
   Helpers
--------------------------------*/
const view = document.getElementById('view');
const toastEl = document.getElementById('toast');
function toast(msg, ms=1800){
  toastEl.textContent = msg; toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'), ms);
}
function openOverlay(html){ document.getElementById('overlayBody').innerHTML = html; document.getElementById('overlay').style.display='grid';}
function closeOverlay(){ document.getElementById('overlay').style.display='none'; }

function lsGet(key, fallback){ try { return JSON.parse(localStorage.getItem(key)) ?? fallback } catch { return fallback } }
function lsSet(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
const store = {
  notes: lsGet('mx_notes', []),   // {placeId, text, date}
  orders: lsGet('mx_orders', [
    { no:'M-251103-001', customer:'Elon Kista', total:248.75, currency:'kr', status:'Skapad', ts: Date.now() }
  ]),
  customers: lsGet('mx_customers', [
    { id:'C1001', name:'Nordic AB', city:'Stockholm', contact:'Eva Berg', phone:'+46 70 123 45 67', org:'556677-8899' },
    { id:'C1002', name:'Stock Wireless', city:'Stockholm', contact:'Jonas Ek', phone:'+46 73 555 66 77', org:'559900-1122' },
    { id:'C1003', name:'Elon Ljud & Bild', city:'V√§ster√•s', contact:'Butikschef', phone:'+46 8 111 22 33', org:'556100-4433' },
    { id:'C1004', name:'Tammerbrands', city:'Tampere', contact:'Ink√∂p', phone:'+358 50 123 45', org:'-' }
  ]),
  inventory: lsGet('mx_inventory', [
    { sku:'A-STICK-CC60', name:'USB-C till USB-C 60W', price:149, stock:73 },
    { sku:'CAR-CHG-60W', name:'Bil-laddare 60W (2-port)', price:199, stock:22 },
    { sku:'LIGHT-27W', name:'USB-C till Lightning 27W', price:179, stock:180 },
    { sku:'A-USB-A-C36', name:'USB-A ‚Üí USB-C 36W', price:129, stock:95 },
  ])
}

/* ------------------------------
   Dashboard
--------------------------------*/
function renderDashboard(){
  view.innerHTML = `
    <div class="grid cols-4">
      ${kpiCard('Oms√§ttning idag','124 500 kr','+6.2%')}
      ${kpiCard('Order idag','37','+4')}
      ${kpiCard('Kostnader (idag)','48 900 kr','‚àí2.1%', true)}
      ${kpiCard('Bruttomarginal','41.5%','+0.7 pp')}
    </div>

    <div class="grid cols-2">
      <div class="card">
        <div class="actions">
          <button class="btn ghost" id="btnExpandGraph">Expandera</button>
          <button class="btn" id="btnAIAnalys">AI-analys</button>
        </div>
        <h3>Ekonomi ‚Äî kombostaplar</h3>
        <canvas id="ecoChart" height="120"></canvas>
      </div>

      <div class="card">
        <div class="actions">
          <button class="btn ghost" id="btnAskMap">Ask AI</button>
        </div>
        <h3>AI-karta (mini)</h3>
        <div id="miniMap"></div>
        <div class="map-actions">
          <button class="btn ghost" id="btnSaveNote">L√§gg notis</button>
          <button class="btn ghost" id="btnViewNotes">Visa notiser</button>
        </div>
      </div>
    </div>

    <div class="grid cols-3">
      <div class="card">
        <div class="actions"><button class="btn primary" id="btnCreateOrder">+ Skapa order</button></div>
        <h3>Senaste order</h3>
        <table>
          <thead><tr><th>#</th><th>Kund</th><th>Summa</th><th>Status</th><th>Tid</th></tr></thead>
          <tbody id="ordersBody"></tbody>
        </table>
      </div>

      <div class="card">
        <h3>Notiser</h3>
        <div id="notifBox">üîî Ny order #M-10306<br/>üßæ PDF-faktura mock genererad</div>
      </div>

      <div class="card">
        <h3>Teamchatt</h3>
        <div id="teamChat" style="height:180px;overflow:auto;border:1px solid var(--glass-stroke);border-radius:10px;padding:8px;background:#fff">
          <div>Anna (Ekonomi): Dagens rapport √§r uppladdad.</div>
          <div>Markus (S√§lj): Kunden vill l√§gga till 50 kablar.</div>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="teamInput" placeholder="Skriv och tryck Enter‚Ä¶" style="flex:1;padding:8px 10px;border:1px solid var(--glass-stroke);border-radius:10px;background:#fff"/>
          <button class="btn" id="teamSend">Skicka</button>
        </div>
      </div>
    </div>
  `;

  // Orders table
  const tbody = document.getElementById('ordersBody');
  tbody.innerHTML = store.orders.map(o=>`
    <tr>
      <td>${o.no}</td><td>${o.customer}</td><td>${o.total} ${o.currency}</td><td>${o.status}</td>
      <td>${new Date(o.ts).toLocaleString('sv-SE')}</td>
    </tr>
  `).join('');

  // Events
  document.getElementById('btnCreateOrder').onclick = ()=>{
    const no = 'M-' + new Date().toISOString().slice(2,10).replaceAll('-','') + '-' + String(Math.floor(Math.random()*900)+100);
    store.orders.unshift({ no, customer:'Acme AB', total:(Math.random()*400+100).toFixed(2), currency:'kr', status:'Skapad', ts:Date.now() });
    lsSet('mx_orders', store.orders);
    toast('Order skapad: '+no);
    renderDashboard();
  };

  document.getElementById('teamSend').onclick = sendTeam;
  document.getElementById('teamInput').addEventListener('keydown', e=>{if(e.key==='Enter'){sendTeam();}});
  function sendTeam(){
    const v = document.getElementById('teamInput').value.trim(); if(!v) return;
    const box = document.getElementById('teamChat');
    const row = document.createElement('div'); row.textContent='Du: '+v; box.appendChild(row); box.scrollTop=99999;
    document.getElementById('teamInput').value='';
  }

  document.getElementById('btnAIAnalys').onclick = ()=>{
    openOverlay(`<h3>AI-analys av ekonomi</h3>
      <p>‚Ä¢ Oms√§ttning v√§xer +6.2% WTD.<br/>
      ‚Ä¢ Kostnader faller ‚àí2.1% ‚Äî bra tr√∂gr√∂rlighet.<br/>
      ‚Ä¢ Prognos bruttomarginal 42‚Äì43% denna period.<br/><br/>
      <button class="btn primary" onclick="closeOverlay()">OK</button>`);
  };
  document.getElementById('btnExpandGraph').onclick = ()=>{
    openOverlay('<h3>Ekonomi ‚Äî kombostaplar (expanderad)</h3><canvas id="ecoBig" height="220"></canvas>');
    setTimeout(()=>makeEcoChart('ecoBig'),30);
  };
  document.getElementById('btnAskMap').onclick = ()=> toast('AI: Rek. rutt idag: Elon Kista ‚Üí Power Solna ‚Üí Mekonomen Bromma (43 min).');

  // Notes
  document.getElementById('btnSaveNote').onclick = ()=> {
    const text = prompt('Skriv notis (ex: "Elon Kista vill k√∂pa om 20 dagar")');
    if(!text) return;
    store.notes.push({placeId:'STHLM', text, date:Date.now()});
    lsSet('mx_notes', store.notes);
    toast('Notis sparad');
  };
  document.getElementById('btnViewNotes').onclick = ()=>{
    if(!store.notes.length){ toast('Inga notiser'); return; }
    openOverlay(`<h3>Notiser (${store.notes.length})</h3>` + store.notes.map(n=>`<div class="card" style="margin-top:8px">
      <div>${n.text}</div><div style="color:var(--muted);font-size:12px">${new Date(n.date).toLocaleString('sv-SE')}</div>
    </div>`).join(''));
  };

  // Charts + map
  makeEcoChart('ecoChart');
  initMiniMap();
}

function kpiCard(title,value,delta,down){
  return `<div class="card kpi">
    <div class="actions"><button class="btn ghost" onclick="openKpiDetail('${title}','${value}','${delta||''}')">Detalj</button></div>
    <div style="color:#475467">${title}</div>
    <div class="value">${value}</div>
    <div class="delta ${down?'down':''}">${delta||''}</div>
  </div>`;
}
function openKpiDetail(title, value, delta){
  openOverlay(`<h3>${title} ‚Äî detalj</h3>
   <p>Idag: <b>${value}</b> (${delta})</p>
   <ul>
    <li>7 dagar: 312 400 kr</li>
    <li>30 dagar: 1 224 900 kr</li>
   </ul>`);
}

function makeEcoChart(canvasId){
  const ctx = document.getElementById(canvasId).getContext('2d');
  new Chart(ctx, {
    type:'bar',
    data:{
      labels:['v1','v2','v3','v4','v5'],
      datasets:[
        {label:'Oms√§ttning', data:[100,140,80,130,160], borderWidth:0, backgroundColor:'#93c5fd'},
        {label:'Kostnader', data:[60,70,45,60,70], borderWidth:0, backgroundColor:'#bae6fd'},
        {type:'line', label:'Brutto%', data:[40,41,40,41,42], tension:.3, borderColor:'#4f46e5', pointRadius:0, yAxisID:'y1'}
      ]
    },
    options:{
      maintainAspectRatio:false,
      scales:{ y:{ beginAtZero:true, grid:{color:'#eef2f7'} }, y1:{ position:'right', grid:{display:false}, ticks:{ callback:v=>v+'%'}}},
      plugins:{ legend:{position:'bottom'} }
    }
  });
}

function initMiniMap(){
  const el = document.getElementById('miniMap');
  el.innerHTML=''; // reset for re-render
  const map = L.map(el, {zoomControl:false}).setView([59.334, 18.063], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);
  const pin = L.marker([59.334, 18.063]).addTo(map);
  pin.bindPopup('Din position (mock)');
  // try GPS
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude, longitude} = pos.coords;
      map.setView([latitude, longitude], 12);
      pin.setLatLng([latitude, longitude]).bindPopup('Din GPS-position');
    }, ()=>{/* keep mock */}, {timeout:2000});
  }
}

/* ------------------------------
   Orders
--------------------------------*/
function renderOrders(){
  view.innerHTML = `
    <div class="card">
      <div class="actions"><button class="btn primary" id="newOrder">+ Skapa order</button></div>
      <h3>Ordrar & fakturor</h3>
      <table>
        <thead><tr><th>Ordernr</th><th>Kund</th><th>Total</th><th>Status</th><th>Betalvillkor</th><th>√Ötg√§rder</th></tr></thead>
        <tbody id="tblOrders"></tbody>
      </table>
    </div>`;
  const tb = document.getElementById('tblOrders');
  tb.innerHTML = store.orders.map(o=>`
    <tr>
      <td>${o.no}</td><td>${o.customer}</td><td>${o.total} kr</td><td>${o.status}</td><td>14 dagar</td>
      <td>
        <button class="btn ghost" onclick="previewPdf('${o.no}')">üëÅ</button>
        <button class="btn" onclick="downloadPdf('${o.no}')">‚¨áÔ∏é PDF</button>
      </td>
    </tr>`).join('');

  document.getElementById('newOrder').onclick = ()=>{
    toast('Orderformul√§r kommer i v8.19 (med f√∂retagsuppgifter & kundkoppling).');
  }
}
function previewPdf(no){
  openOverlay(`<h3>F√∂rhandsgranska faktura</h3><div class="card">
  <div>Faktura: ${no}</div><div>F√∂retag: MergX AB</div><div>Adress: Exempelgatan 1, 111 11 Stockholm</div><br/>
  <i>PDF-mock. Export kopplas i n√§sta sprint.</i></div>`);
}
function downloadPdf(no){ toast('Skapar PDF f√∂r '+no+' (mock)‚Ä¶'); }

/* ------------------------------
   Customers
--------------------------------*/
function renderCustomers(){
  view.innerHTML = `
    <div class="card">
      <div class="actions"><button class="btn primary" id="addCust">+ L√§gg till kund</button></div>
      <h3>Kunder</h3>
      <table>
        <thead><tr><th>ID</th><th>F√∂retag</th><th>Kontakt</th><th>Telefon</th><th>Stad</th><th>√Ötg√§rder</th></tr></thead>
        <tbody id="custBody"></tbody>
      </table>
    </div>`;
  const tb = document.getElementById('custBody');
  tb.innerHTML = store.customers.map(c=>`
    <tr>
      <td>${c.id}</td><td><a href="javascript:void(0)" onclick="openCustomer('${c.id}')">${c.name}</a></td>
      <td>${c.contact}</td><td>${c.phone}</td><td>${c.city}</td>
      <td>
        <button class="btn ghost" onclick="editCustomer('${c.id}')">Redigera</button>
        <button class="btn" onclick="newOrderFor('${c.name}')">+ Order</button>
      </td>
    </tr>`).join('');

  document.getElementById('addCust').onclick = ()=>{
    toast('Kundformul√§r + valideringar kommer i v8.19'); 
  }
}
function openCustomer(id){
  const c = store.customers.find(x=>x.id===id);
  openOverlay(`<h3>${c.name}</h3>
   <div class="card">
    <div>Org.nr: ${c.org}</div><div>Kontakt: ${c.contact}</div><div>Telefon: ${c.phone}</div><div>Stad: ${c.city}</div>
    <br/><button class="btn" onclick="newOrderFor('${c.name}')">+ Skapa order</button>
    <button class="btn ghost" onclick="closeOverlay()">St√§ng</button>
   </div>`);
}
function editCustomer(id){ toast('Redigera kund (mock).'); }
function newOrderFor(name){
  store.orders.unshift({ no:'M-'+Date.now(), customer:name, total:(Math.random()*500+150).toFixed(2), currency:'kr', status:'Skapad', ts:Date.now() });
  lsSet('mx_orders', store.orders);
  toast('Order skapad f√∂r '+name);
  closeOverlay();
}

/* ------------------------------
   Inventory
--------------------------------*/
function renderInventory(){
  view.innerHTML = `
    <div class="card">
      <div class="actions"><button class="btn primary" id="addItem">+ L√§gg till produkt</button></div>
      <h3>Inventarie</h3>
      <table>
       <thead><tr><th>SKU</th><th>Namn</th><th>Pris</th><th>Lagersaldo</th><th>√Ötg√§rder</th></tr></thead>
       <tbody id="invBody"></tbody>
      </table>
    </div>`;
  const tb = document.getElementById('invBody');
  tb.innerHTML = store.inventory.map(p=>`
    <tr>
      <td>${p.sku}</td><td>${p.name}</td><td>${p.price} kr</td>
      <td>${p.stock} ${p.stock<25?'<span style="color:var(--danger)">‚ö† l√•g niv√•</span>':''}</td>
      <td>
        <button class="btn ghost" onclick="toast('Redigera ${p.sku}')">Redigera</button>
        <button class="btn" onclick="toast('Ta bort ${p.sku} (mock)')">Ta bort</button>
      </td>
    </tr>`).join('');
  document.getElementById('addItem').onclick = ()=> toast('Produktformul√§r kommer i v8.19 (inkl. bilder & kategorier).');
}

/* ------------------------------
   Employees / Files / Chat / Settings (mock skeletons)
--------------------------------*/
function renderEmployees(){
  view.innerHTML = `<div class="card"><h3>Anst√§llda</h3>
  <p>Roller & schema kommer i v8.19. (RBAC-mock)</p></div>`;
}
function renderFiles(){
  view.innerHTML = `<div class="card"><h3>Filer & kvitton</h3>
  <p>Uppladdning, taggar, arbetsfl√∂de till Ekonomi i v8.19.</p></div>`;
}
function renderChat(){
  view.innerHTML = `<div class="card"><h3>Chatt</h3>
  <p>Teamchatt + AI-verktyg visas ocks√• i dockan nedre h√∂gra h√∂rnet.</p></div>`;
}
function renderSettings(){
  view.innerHTML = `<div class="card"><h3>Inst√§llningar</h3>
  <ul>
   <li>F√∂retagsuppgifter f√∂r fakturor</li>
   <li>API-nycklar (Fraktjakt, Finans, AI)</li>
   <li>Spr√•k/Tema</li>
  </ul>
  <p>Formul√§r implementeras i v8.19.</p></div>`;
}

/* ------------------------------
   AI-map full page
--------------------------------*/
function renderAIMap(){
  view.innerHTML = `
    <div class="card">
      <div class="actions">
        <button class="btn" id="btnSuggest">AI-rekommendation</button>
        <button class="btn ghost" id="btnAddNote">L√§gg notis</button>
        <button class="btn ghost" id="btnShowNotes">Visa notiser</button>
      </div>
      <h3>AI-karta ‚Äî Sales Route Planner</h3>
      <div id="aiMap"></div>
    </div>`;
  const map = L.map('aiMap').setView([59.334, 18.063], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);
  const you = L.marker([59.334,18.063]).addTo(map).bindPopup('Du (mock)');

  const places = [
    { id:'ELON-KISTA', name:'Elon Kista', lat:59.403, lng:17.946 },
    { id:'POWER-SOLNA', name:'Power Solna', lat:59.365, lng:18.004 },
    { id:'MEKO-BROMMA', name:'Mekonomen Bromma', lat:59.355, lng:17.954 },
  ];
  places.forEach(p=>{
    const m = L.marker([p.lat,p.lng]).addTo(map);
    m.bindPopup(`<b>${p.name}</b><br/><button onclick="addMapNote('${p.id}')">L√§gg notis</button>`);
  });

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude, longitude} = pos.coords; you.setLatLng([latitude, longitude]).bindPopup('Du (GPS)');
      map.setView([latitude, longitude], 12);
    },()=>{}, {timeout:2000});
  }

  document.getElementById('btnSuggest').onclick = ()=>{
    toast('AI: F√∂resl√•r rutt ‚Äì Elon Kista ‚Üí Power Solna ‚Üí Mekonomen Bromma (43 min).');
  };
  document.getElementById('btnAddNote').onclick = ()=> {
    const text = prompt('Notis:'); if(!text) return;
    store.notes.push({placeId:'GENERIC', text, date:Date.now()}); lsSet('mx_notes', store.notes); toast('Notis sparad');
  };
  document.getElementById('btnShowNotes').onclick = ()=>{
    if(!store.notes.length){ toast('Inga notiser'); return; }
    openOverlay('<h3>Platsnotiser</h3>'+ store.notes.map(n=>`<div class="card" style="margin-top:8px">${n.text}<div style="color:#7a7f8c;font-size:12px">${new Date(n.date).toLocaleString('sv-SE')}</div></div>`).join(''));
  };
}
// global for popup button
function addMapNote(placeId){
  const txt = prompt('Notis f√∂r '+placeId+':'); if(!txt) return;
  store.notes.push({placeId, text:txt, date:Date.now()}); lsSet('mx_notes', store.notes); toast('Notis sparad');
}

/* ------------------------------
   Chat dock (AI-coach mock)
--------------------------------*/
const dockBody = document.getElementById('dockBody');
const dockInput = document.getElementById('dockInput');
document.getElementById('dockSend').onclick = sendDock;
dockInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendDock(); });

function sendDock(){
  const v = dockInput.value.trim(); if(!v) return;
  dockBody.appendChild(msgEl('me', v));
  dockInput.value=''; dockBody.scrollTop=99999;
  setTimeout(()=>{
    dockBody.appendChild(msgEl('ai', smartReply(v)));
    dockBody.scrollTop=99999;
  }, 300);
}
function msgEl(type, text){ const d=document.createElement('div'); d.className='msg '+type; d.textContent=text; return d; }
function smartReply(q){
  q = q.toLowerCase();
  if(q.includes('oms√§tt')) return 'Oms√§ttning idag 124 500 kr (+6.2%). 7 dagar: 312 400 kr. 30 dagar: 1 224 900 kr.';
  if(q.includes('rutt')||q.includes('karta')) return 'F√∂resl√•r: Elon Kista ‚Üí Power Solna ‚Üí Mekonomen Bromma (43 min). L√§gg g√§rna en notis efter bes√∂k.';
  if(q.includes('lager')||q.includes('brist')) return 'Bristvarning: CAR-CHG-60W saldo 22. F√∂rslag: best√§ll 100 st.';
  return 'Jag noterade det. Vill du att jag skapar en uppgift eller spar en notis?';
}

/* ------------------------------
   Global search (mock)
--------------------------------*/
document.getElementById('globalSearch').addEventListener('keydown',(e)=>{
  if(e.key==='Enter'){
    toast('S√∂k: '+e.target.value);
  }
});
</script>
</body>
</html>
