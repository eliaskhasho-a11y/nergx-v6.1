<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MergX v8.17 ‚Äì Core Expansion (Light + Glass)</title>

  <!-- Pastell/glas tema + spacing fix -->
  <style>
    :root{
      --bg: #f6f8fb;
      --card: rgba(255,255,255,0.66);
      --glass-border: 1px solid rgba(255,255,255,0.8);
      --shadow: 0 8px 30px rgba(16,24,40,.08);
      --radius: 16px;
      --primary: #4bb6e5;         /* turkos bl√• (pastell) */
      --primary-2:#7fd3ee;         /* sekund√§r gradient */
      --accent: #6dd6b0;           /* gr√∂n pastell */
      --danger: #ff6b6b;
      --text: #0f172a;             /* gr√•svart */
      --muted: #667085;            /* gr√• text */
      --line: #e6e9ef;
      --chip: #eef7ff;
      --ok: #1f9751;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font: 14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;
      color:var(--text);
      background:
        radial-gradient(60rem 60rem at -10% -20%, #eaf6ff 10%, transparent 60%),
        radial-gradient(60rem 60rem at 120% -30%, #f7fffb 10%, transparent 60%),
        var(--bg);
    }

    /* Layout */
    .app{
      display:grid;
      grid-template-columns: 260px 1fr;
      min-height:100dvh;
    }
    aside{
      position:sticky; top:0; height:100dvh; overflow:auto;
      padding:18px;
      backdrop-filter:saturate(150%) blur(10px);
      background: linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.5));
      border-right:1px solid rgba(0,0,0,.04);
    }
    main{
      padding:22px 26px 40px;
    }

    /* Sidebar */
    .brand{
      display:flex; align-items:center; gap:10px; margin-bottom:12px;
    }
    .brand .logo{
      width:28px;height:28px;border-radius:8px;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      display:grid; place-items:center; color:#fff; font-weight:700;
      box-shadow: var(--shadow);
    }
    .version{font-size:12px;color:var(--muted)}
    nav a{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; margin:4px 0; color:#0f172a; text-decoration:none;
      border-radius:12px;
    }
    nav a.active, nav a:hover{
      background:var(--chip);
      color:#0b3a53;
    }
    .chip{
      display:inline-block; padding:2px 8px; border-radius:999px;
      background:#eef4ff; color:#334; font-size:12px; margin-left:auto;
    }

    /* Header */
    .toolbar{
      display:flex; align-items:center; gap:14px; margin-bottom:18px;
    }
    .search{
      position:relative; flex:1;
    }
    .search input{
      width:100%; height:44px; padding:0 16px 0 40px;
      border-radius:12px; border:1px solid var(--line); outline:0;
      background:var(--card); box-shadow:var(--shadow); backdrop-filter: blur(8px);
    }
    .search svg{ position:absolute; left:12px; top:10px; opacity:.7 }
    .badge{
      background:#fff; border:1px solid var(--line); padding:8px 10px; border-radius:10px;
    }
    .spacer{flex:1}

    /* Cards & Grid */
    .grid{
      display:grid; gap:16px;
    }
    .grid.stats{ grid-template-columns: repeat(4, minmax(220px,1fr)); }
    .grid.main{
      grid-template-columns: 1.8fr 1fr;
      grid-template-rows: auto auto;
    }
    .card{
      background:var(--card); backdrop-filter: blur(8px);
      border:var(--glass-border); border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .card.pad{ padding:16px; }
    .card h3{ margin:0 0 8px; font-size:15px; color:#0f172a }
    .metric{ font-weight:700; font-size:20px; }
    .sub{ color:var(--muted); font-size:12px; }

    /* Tables */
    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:10px 12px; border-bottom:1px solid var(--line); text-align:left; }
    th{ color:#475467; font-size:12px; text-transform:uppercase; letter-spacing:.02em }
    tr:hover td{ background: #f7fbff }

    .btn{
      height:34px; padding:0 12px; border-radius:10px; border:1px solid var(--line);
      background:#fff; cursor:pointer;
    }
    .btn.primary{ background: linear-gradient(135deg,var(--primary),var(--primary-2)); color:#fff; border:0 }
    .btn.ghost{ background:transparent }
    .btn.icon{ display:inline-grid; place-items:center; width:34px }
    .btn.small{ height:28px; font-size:12px; padding:0 10px }

    .tag{ font-size:12px; padding:2px 8px; background:#eef7ff; border-radius:999px }
    .tag.ok{ background:#ecfdf3; color:var(--ok) }
    .tag.warn{ background:#fff7ed; color:#b45309 }

    /* Right tray (AI Coach + Notiser) */
    .tray{
      display:grid; gap:16px;
      grid-template-columns:1fr;
    }
    .chatbox{
      display:grid; gap:10px;
    }
    .bubble{ padding:8px 12px; background:#edf2fb; border-radius:14px; max-width:80% }
    .bubble.me{ background:#e6fbff; justify-self:end }
    .chat-input{
      display:flex; gap:8px; align-items:center; border:1px solid var(--line);
      border-radius:12px; padding:6px 8px; background:#fff;
    }
    .chat-input input{
      flex:1; height:32px; border:0; outline:0; background:transparent;
    }

    /* Map height */
    #map{ height:260px; border-radius:12px; border:1px solid var(--line); }

    /* Modal */
    .modal{
      position: fixed; inset:0; background:rgba(0,0,0,.25);
      display:none; place-items:center; padding:20px; z-index: 50;
    }
    .modal.show{ display:grid }
    .modal .dialog{
      width:min(860px, 92vw); background:#fff; border-radius:14px; box-shadow:var(--shadow);
      border:1px solid var(--line); overflow:hidden;
    }
    .dialog header{
      padding:12px 16px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:8px;
    }
    .dialog main{ padding:16px }
    .dialog footer{ padding:12px 16px; border-top:1px solid var(--line); display:flex; gap:8px; justify-content:flex-end }

    /* Notis flyout */
    .notis-btn{ position:relative }
    .notis-dot{
      position:absolute; top:-2px; right:-2px; width:10px; height:10px; border-radius:50%;
      background:#ef4444; border:2px solid #fff;
    }
    .flyout{
      position:fixed; right:20px; top:66px; width:360px; max-height:70vh; overflow:auto;
      background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:var(--shadow); display:none;
      z-index:40;
    }
    .flyout.show{ display:block }
    .flyout .row{ padding:10px 12px; border-bottom:1px solid var(--line); font-size:13px }
    .flyout .row:last-child{ border-bottom:0 }

    /* Responsive */
    @media (max-width: 1200px){
      .grid.stats{ grid-template-columns: repeat(2,1fr); }
      .grid.main{ grid-template-columns: 1fr; }
    }
  </style>

  <!-- Chart.js + Leaflet + jsPDF (PDF mock) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>

<div class="app">

  <!-- SIDEBAR -->
  <aside>
    <div class="brand">
      <div class="logo">X</div>
      <div>
        <div style="font-weight:700">MergX</div>
        <div class="version">Base 8.17 ‚Ä¢ Online</div>
      </div>
    </div>

    <nav id="nav">
      <a href="#dashboard" data-route="dashboard" class="active">√ñversikt <span class="chip">AI</span></a>
      <a href="#crm" data-route="crm">Kunder / CRM</a>
      <a href="#inventory" data-route="inventory">Inventarie</a>
      <a href="#orders" data-route="orders">Ordrar & Fakturor</a>
      <a href="#economy" data-route="economy">Ekonomi / Rapporter</a>
      <a href="#files" data-route="files">Filer & Kvitton</a>
      <a href="#settings" data-route="settings">Inst√§llningar</a>
    </nav>
  </aside>

  <!-- MAIN -->
  <main>

    <!-- TOOLBAR -->
    <div class="toolbar">
      <div class="search" style="z-index: 45;">
        <svg width="22" height="22" viewBox="0 0 24 24"><path fill="#64748b" d="M21 20.3 16.7 16A7.5 7.5 0 1 0 16 16.7L20.3 21 21 20.3ZM4 10.5A6.5 6.5 0 1 1 10.5 17 6.5 6.5 0 0 1 4 10.5Z"/></svg>
        <input id="globalSearch" placeholder="Global s√∂k (‚åò/Ctrl + K) ‚Äì kunder, ordrar, dokument ‚Ä¶"/>
      </div>
      <div class="badge">Roll: <strong>Admin</strong></div>
      <div class="badge">Spr√•k: <strong>Svenska</strong></div>

      <button id="notisBtn" class="btn notis-btn" title="Notiser">
        üîî Notiser <span class="notis-dot"></span>
      </button>
      <button class="btn" onclick="location.hash='#dashboard'">G√• till √ñversikt</button>
    </div>

    <!-- NOTISER FLYOUT -->
    <div id="notisFlyout" class="flyout card">
      <div class="row"><strong>üßæ PDF-faktura mock genererad</strong> ¬∑ 08:09</div>
      <div class="row"><strong>üõí Ny order #M-10306</strong> ¬∑ 08:08</div>
      <div class="row"><strong>üì¶ L√•gt lager</strong> ¬∑ USB-C 60W (saldo 22)</div>
      <div class="row"><button class="btn small" onclick="this.closest('.flyout').classList.remove('show')">Markera som l√§st</button></div>
    </div>

    <!-- ROUTES -->
    <section id="route-dashboard">

      <!-- STATS -->
      <div class="grid stats">
        <div class="card pad">
          <div class="sub">Oms√§ttning idag</div>
          <div class="metric" id="mSales">124 500 kr</div>
          <div class="tag ok">+6.2%</div>
        </div>
        <div class="card pad">
          <div class="sub">Order idag</div>
          <div class="metric" id="mOrders">37</div>
          <div class="tag ok">+4</div>
        </div>
        <div class="card pad">
          <div class="sub">Kostnader (idag)</div>
          <div class="metric">48 900 kr</div>
          <div class="tag">‚àí2.1%</div>
        </div>
        <div class="card pad">
          <div class="sub">Bruttomarginal</div>
          <div class="metric">41.5%</div>
          <div class="tag ok">+0.7 pp</div>
        </div>
      </div>

      <!-- MAIN GRID -->
      <div class="grid main" style="margin-top:16px">
        <div class="card pad">
          <h3>Ekonomi ‚Äî kombostaplar</h3>
          <canvas id="ecoChart" height="120"></canvas>
        </div>

        <div class="card pad">
          <h3>AI-karta (mini)</h3>
          <div id="map"></div>
          <div style="text-align:center;margin-top:8px">
            <button class="btn small" onclick="alert('AI-rekommendationer (mock).')">AI-rekommendationer</button>
          </div>
        </div>

        <!-- Teamchatt -->
        <div class="card pad">
          <h3>Teamchatt</h3>
          <div id="chat" class="chatbox" style="min-height:160px">
            <div class="bubble">God morgon teamet!</div>
            <div class="bubble me">Jag tar kundm√∂tet 11:00.</div>
          </div>
          <div class="chat-input" style="margin-top:8px">
            <button class="btn icon" title="Bifoga">üìé</button>
            <input id="chatInput" placeholder="Skriv ett meddelande‚Ä¶ (Enter f√∂r att skicka)" />
            <button class="btn" onclick="sendChat()">Skicka</button>
          </div>
        </div>

        <!-- Ordrar & fakturor -->
        <div class="card pad">
          <h3>Ordrar & fakturor</h3>
          <table>
            <thead>
              <tr><th>Nr</th><th>Kund</th><th>Total</th><th>Status</th><th>√Ötg√§rder</th></tr>
            </thead>
            <tbody id="ordersTbody">
              <!-- fylld via JS -->
            </tbody>
          </table>
        </div>

        <!-- Notiser + AI Coach (tr√§ys i en kolumn p√• sm√• sk√§rmar) -->
        <div class="tray" style="grid-column:1/-1">
          <div class="card pad">
            <h3>Notiser</h3>
            <div id="notisList">
              <div>üîî Ny order #M-10306</div>
              <div>üßæ PDF-faktura mock genererad</div>
            </div>
          </div>

          <div class="card pad">
            <h3>AI-Coach ‚Ä¢ proaktiv assistent</h3>
            <div id="aicoachLog" class="chatbox" style="min-height:120px">
              <div class="bubble">Hej! Jag √§r din AI-coach. Jag bevakar KPI:er, lager och deadlines.</div>
            </div>
            <div class="chat-input" style="margin-top:8px">
              <input id="aicoachInput" placeholder="Skriv ett meddelande‚Ä¶ (Enter f√∂r att skicka)"/>
              <button class="btn" onclick="askCoach()">Skicka</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CRM -->
    <section id="route-crm" style="display:none">
      <div class="card pad">
        <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
          <h3>Kunder</h3>
          <button class="btn primary" onclick="openCustomerModal()">+ L√§gg till kund</button>
        </div>

        <table id="crmTable" style="margin-top:8px">
          <thead>
            <tr>
              <th>ID</th><th>F√∂retag</th><th>Kontakt</th><th>E-post</th><th>Telefon</th><th>Stad</th><th>√Ötg√§rder</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- INVENTORY -->
    <section id="route-inventory" style="display:none">
      <div class="card pad">
        <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
          <h3>Inventarie</h3>
          <button class="btn primary" onclick="openProductModal()">+ L√§gg till produkt</button>
        </div>

        <table id="invTable" style="margin-top:8px">
          <thead>
            <tr><th>SKU</th><th>Namn</th><th>Typ</th><th>Pris</th><th>Lagersaldo</th><th>√Ötg√§rder</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ORDERS -->
    <section id="route-orders" style="display:none">
      <div class="card pad">
        <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
          <h3>Ordrar & Fakturor</h3>
          <button class="btn primary" onclick="createOrder()">Skapa order (mock)</button>
        </div>
        <table style="margin-top:8px">
          <thead><tr><th>Ordernr</th><th>Kund</th><th>Total</th><th>Betalvillkor</th><th>√Ötg√§rder</th></tr></thead>
          <tbody id="ordersFull"></tbody>
        </table>
      </div>
    </section>

    <!-- ECONOMY -->
    <section id="route-economy" style="display:none">
      <div class="grid" style="grid-template-columns:1.2fr .8fr; gap:16px">
        <div class="card pad">
          <h3>Ekonomi / Rapporter</h3>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <select id="ecoRange" class="btn">
              <option value="month">M√•nad</option>
              <option value="quarter">Kvartal</option>
              <option value="year">√Ör</option>
            </select>
            <button class="btn" onclick="exportCSV()">Export CSV</button>
            <button class="btn" onclick="exportXLSX()">Export Excel (mock)</button>
            <button class="btn" onclick="exportPDF()">Export PDF</button>
            <button class="btn primary" onclick="sendToAuditor()">Skicka till revisor</button>
          </div>
          <canvas id="ecoBig" height="140"></canvas>
        </div>

        <div class="card pad">
          <h3>AI-analys</h3>
          <div id="ecoInsight" class="chatbox">
            <div class="bubble">Oms√§ttning trend upp +6%. Kostnader -2.1%. Prognos +3% kommande vecka.</div>
          </div>
          <div class="chat-input" style="margin-top:8px">
            <input id="ecoQ" placeholder="Fr√•ga AI om ekonomi‚Ä¶"/>
            <button class="btn" onclick="askEcoAI()">Fr√•ga</button>
          </div>
        </div>
      </div>
    </section>

    <!-- FILES (placeholder) -->
    <section id="route-files" style="display:none">
      <div class="card pad">
        <h3>Filer & Kvitton</h3>
        <p>H√§r kopplas kvitto-upload, mappar och arbetsfl√∂de till Ekonomi/Admin.</p>
        <button class="btn">Ladda upp (mock)</button>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="route-settings" style="display:none">
      <div class="card pad">
        <h3>Inst√§llningar</h3>
        <p>Grundinst√§llningar f√∂r tema, spr√•k, AI-leverant√∂rer (Deepseek/Ollama), roller och aviseringar.</p>
      </div>
    </section>

  </main>
</div>

<!-- GENERIC MODAL -->
<div id="modal" class="modal">
  <div class="dialog">
    <header>
      <strong id="modalTitle">Dialog</strong>
      <span class="spacer"></span>
      <button class="btn icon" onclick="closeModal()">‚úï</button>
    </header>
    <main id="modalBody">Inneh√•ll‚Ä¶</main>
    <footer id="modalFooter">
      <button class="btn" onclick="closeModal()">St√§ng</button>
    </footer>
  </div>
</div>

<script>
/* ---------------- ROUTER ---------------- */
const routes = ["dashboard","crm","inventory","orders","economy","files","settings"];
function syncRoute(){
  let hash = (location.hash || "#dashboard").replace('#','');
  if(!routes.includes(hash)) hash = 'dashboard';
  routes.forEach(r=>{
    document.getElementById('route-'+r).style.display = (r===hash?'block':'none');
    document.querySelectorAll('#nav a').forEach(a=>{
      a.classList.toggle('active', a.dataset.route===hash);
    });
  });
}
window.addEventListener('hashchange', syncRoute);
syncRoute();

/* --------------- NOTIS FLYOUT -------------- */
const notisBtn = document.getElementById('notisBtn');
const notisFly = document.getElementById('notisFlyout');
notisBtn.addEventListener('click', ()=> notisFly.classList.toggle('show'));

/* --------------- CHART (dashboard) -------------- */
const ecoChart = new Chart(document.getElementById('ecoChart'),{
  type:'bar',
  data:{
    labels:['v1','v2','v3','v4','v5'],
    datasets:[
      {label:'Oms√§ttning', data:[100,120,90,140,160], backgroundColor:'#bfe8ff'},
      {label:'Kostnader', data:[40,65,45,60,72], backgroundColor:'#d9f7ef'},
      {label:'Brutto%', type:'line', data:[40,41,42,43,44], borderColor:'#7aa5ff', borderWidth:2, yAxisID:'y1', tension:.3}
    ]
  },
  options:{
    scales:{
      y: { beginAtZero:true, grid:{color:'#eef2f7'} },
      y1:{ position:'right', beginAtZero:false, grid:{display:false}, ticks:{callback:v=>v+'%'} }
    },
    plugins:{ legend:{ labels:{ color:'#475467' } } }
  }
});

/* --------------- MAP (mini) -------------- */
const map = L.map('map',{ zoomControl:false, attributionControl:true }).setView([59.334591,18.06324], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
L.marker([59.334591,18.06324]).addTo(map).bindPopup('Stockholm');

/* --------------- DUMMY DATA -------------- */
let customers = [
  {id:'C1001', company:'Nordic AB', contact:'Eva Berg', email:'eva@nordic.se', phone:'+46 70 123 45 67', city:'Stockholm', notes:[]},
  {id:'C1002', company:'Stock Wireless', contact:'Jonas Ek', email:'sales@stockwireless.se', phone:'+46 73 555 66 77', city:'Stockholm', notes:[]},
  {id:'C1003', company:'Elon Ljud & Bild', contact:'Butikschef', email:'info@elonlb.se', phone:'+46 8 111 22 33', city:'V√§ster√•s', notes:[]},
  {id:'C1004', company:'Tammerbrands', contact:'Ink√∂p', email:'buy@tammerbrands.fi', phone:'+358 50 123 45', city:'Tampere', notes:[]}
];
let products = [
  {sku:'A-STICK-CC60', name:'USB-C till USB-C 60W', type:'Kabel', price:149, stock:22},
  {sku:'CAR-CHG-60W', name:'Bil-laddare 60W (2-port)', type:'Laddare', price:199, stock:44},
  {sku:'LIGHT-27W', name:'USB-C till Lightning 27W', type:'Kabel', price:179, stock:128},
  {sku:'A-USB-A-C36', name:'USB-A till USB-C 36W', type:'Kabel', price:129, stock:95}
];
let orders = [
  {no:'#10234', customer:'Acme AB', total:'24 900 kr', status:'Skapad idag'},
  {no:'#10231', customer:'Elon City', total:'12 200 kr', status:'Skapad ig√•r'},
];

/* --------------- RENDER: CRM -------------- */
function renderCRM(){
  const tb = document.querySelector('#crmTable tbody');
  tb.innerHTML = '';
  customers.forEach((c,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${c.id}</td>
      <td><a href="#" onclick="openCustomerDetail('${c.id}');return false;">${c.company}</a></td>
      <td>${c.contact}</td>
      <td>${c.email}</td>
      <td>${c.phone}</td>
      <td>${c.city}</td>
      <td>
        <button class="btn small" onclick="openCustomerModal('${c.id}')">Redigera</button>
        <button class="btn small" onclick="deleteCustomer(${i})">Ta bort</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}
renderCRM();

/* --------------- RENDER: INVENTORY -------------- */
function renderInventory(){
  const tb = document.querySelector('#invTable tbody');
  tb.innerHTML='';
  products.forEach((p,i)=>{
    const warn = p.stock < 25 ? '<span class="tag warn">‚ö† l√•g niv√•</span>' : '';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.sku}</td>
      <td><a href="#" onclick="openProductDetail('${p.sku}');return false;">${p.name}</a></td>
      <td>${p.type}</td>
      <td>${p.price} kr</td>
      <td>${p.stock} ${warn}</td>
      <td>
        <button class="btn small" onclick="openProductModal('${p.sku}')">Redigera</button>
        <button class="btn small" onclick="deleteProduct(${i})">Ta bort</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}
renderInventory();

/* --------------- RENDER: ORDERS (dashboard & full) -------------- */
function renderOrders(){
  const tb1 = document.getElementById('ordersTbody');
  const tb2 = document.getElementById('ordersFull');
  tb1.innerHTML = ''; tb2.innerHTML = '';
  orders.forEach(o=>{
    const tr1 = document.createElement('tr');
    tr1.innerHTML = `
      <td>${o.no}</td><td>${o.customer}</td><td>${o.total}</td><td>${o.status}</td>
      <td>
        <button class="btn small" onclick="previewInvoice('${o.no}')">üëÅ F√∂rhandsgranska</button>
        <button class="btn small" onclick="downloadPDF('${o.no}')">‚¨áÔ∏é PDF</button>
      </td>`;
    tb1.appendChild(tr1);

    const tr2 = document.createElement('tr');
    tr2.innerHTML = `
      <td>${o.no}</td><td>${o.customer}</td><td>${o.total}</td><td>14 dagar</td>
      <td>
        <button class="btn small" onclick="previewInvoice('${o.no}')">üëÅ</button>
        <button class="btn small" onclick="downloadPDF('${o.no}')">PDF</button>
      </td>`;
    tb2.appendChild(tr2);
  });
}
renderOrders();

/* --------------- CHAT & AI COACH -------------- */
function sendChat(){
  const input = document.getElementById('chatInput');
  if(!input.value.trim()) return;
  const div = document.createElement('div');
  div.className='bubble me'; div.textContent = input.value.trim();
  document.getElementById('chat').appendChild(div);
  input.value='';
}
document.getElementById('chatInput').addEventListener('keydown',e=>{
  if(e.key==='Enter'){ e.preventDefault(); sendChat(); }
});

function askCoach(){
  const input = document.getElementById('aicoachInput');
  const log = document.getElementById('aicoachLog');
  const q = input.value.trim(); if(!q) return;
  log.appendChild(Object.assign(document.createElement('div'),{className:'bubble me',textContent:q}));
  // mock svar
  let a = 'Jag analyserar‚Ä¶';
  if(/lager|slut/i.test(q)) a = 'L√•gt lager: USB-C 60W (saldo 22). F√∂rslag: best√§ll +150 st.';
  if(/budget|prognos/i.test(q)) a = 'Prognos: +3% oms√§ttning kommande 7 dagar baserat p√• trend.';
  if(/kund|top/i.test(q)) a = 'Toppkunder denna m√•nad: Nordic AB, Stock Wireless.';
  log.appendChild(Object.assign(document.createElement('div'),{className:'bubble',textContent:a}));
  input.value='';
}
document.getElementById('aicoachInput').addEventListener('keydown',e=>{
  if(e.key==='Enter'){ e.preventDefault(); askCoach(); }
});

/* --------------- MODAL HELPERS -------------- */
const modal = document.getElementById('modal');
function openModal(title, bodyHTML, footerHTML){
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalBody').innerHTML = bodyHTML;
  document.getElementById('modalFooter').innerHTML = footerHTML || '<button class="btn" onclick="closeModal()">St√§ng</button>';
  modal.classList.add('show');
}
function closeModal(){ modal.classList.remove('show'); }

/* --------------- CUSTOMER DETAIL + AUDIO NOTES -------------- */
function openCustomerDetail(id){
  const c = customers.find(x=>x.id===id);
  let notes = (c.notes||[]).map(n=>`<li><a href="${n.url}" target="_blank">${n.name}</a> ¬∑ ${n.when}</li>`).join('') || '<li>Inga ljudnotiser √§nnu.</li>';
  const body = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div><strong>F√∂retag</strong><br>${c.company}</div>
      <div><strong>Kontakt</strong><br>${c.contact}</div>
      <div><strong>E-post</strong><br>${c.email}</div>
      <div><strong>Telefon</strong><br>${c.phone}</div>
      <div><strong>Stad</strong><br>${c.city}</div>
    </div>
    <hr>
    <h4>Ljud-notiser</h4>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn small" onclick="startRec('${id}')">‚è∫ Spela in</button>
      <button class="btn small" onclick="stopRec('${id}')">‚èπ Stoppa</button>
      <button class="btn small" onclick="summarizeAudio('${id}')">üß† Sammanfatta (mock)</button>
    </div>
    <ul id="audioList" style="margin-top:8px">${notes}</ul>
  `;
  openModal('Kund ‚Ä¢ '+c.company, body, `<button class="btn" onclick="closeModal()">St√§ng</button>`);
}
let mediaRecorder, chunks=[];
async function startRec(id){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e=> chunks.push(e.data);
    mediaRecorder.onstop = ()=>{
      const blob = new Blob(chunks,{type:'audio/webm'});
      chunks=[];
      const url = URL.createObjectURL(blob);
      const name = 'customer-note.webm';
      const li = document.createElement('li');
      li.innerHTML = `<a href="${url}" target="_blank">${name}</a> ¬∑ ${new Date().toLocaleString()}`
      document.getElementById('audioList').appendChild(li);
    };
    mediaRecorder.start();
    alert('Inspelning startad‚Ä¶');
  }catch(e){ alert('Mikrofonen √§r inte tillg√§nglig i denna milj√∂. (Mocka vid behov)'); }
}
function stopRec(){ try{ mediaRecorder && mediaRecorder.stop(); }catch{} }
function summarizeAudio(id){
  alert('AI-sammanfattning (mock): ‚ÄúKort kunduppf√∂ljning, n√§mner tid 11:00 och orderstatus. F√∂resl√•r nytt samtal fredag.‚Äù');
}

/* --------------- CUSTOMER CRUD -------------- */
function openCustomerModal(id){
  const edit = !!id;
  const c = edit ? customers.find(x=>x.id===id) : {id:'',company:'',contact:'',email:'',phone:'',city:''};
  const body = `
    <div style="display:grid;grid-template-columns:1fr 1fr; gap:10px">
      <label>ID<br><input id="c_id" class="btn" value="${c.id}"></label>
      <label>F√∂retag<br><input id="c_company" class="btn" value="${c.company}"></label>
      <label>Kontakt<br><input id="c_contact" class="btn" value="${c.contact}"></label>
      <label>E-post<br><input id="c_email" class="btn" value="${c.email}"></label>
      <label>Telefon<br><input id="c_phone" class="btn" value="${c.phone}"></label>
      <label>Stad<br><input id="c_city" class="btn" value="${c.city}"></label>
    </div>`;
  const footer = `
    <button class="btn" onclick="closeModal()">Avbryt</button>
    <button class="btn primary" onclick="saveCustomer(${edit})">Spara</button>`;
  openModal((edit?'Redigera':'L√§gg till')+' kund', body, footer);
  if(edit) document.getElementById('c_id').disabled = true;
}
function saveCustomer(edit){
  const c = {
    id: document.getElementById('c_id').value.trim(),
    company: document.getElementById('c_company').value.trim(),
    contact: document.getElementById('c_contact').value.trim(),
    email: document.getElementById('c_email').value.trim(),
    phone: document.getElementById('c_phone').value.trim(),
    city: document.getElementById('c_city').value.trim()
  };
  if(edit){
    const i = customers.findIndex(x=>x.id===c.id);
    customers[i] = {...customers[i], ...c};
  }else{
    customers.push(c);
  }
  renderCRM(); closeModal();
}
function deleteCustomer(i){
  if(confirm('Ta bort kund?')){ customers.splice(i,1); renderCRM(); }
}

/* --------------- PRODUCT DETAIL + CRUD -------------- */
function openProductDetail(sku){
  const p = products.find(x=>x.sku===sku);
  const body = `
    <div style="display:grid;grid-template-columns:1fr 1fr; gap:10px">
      <div><strong>SKU</strong><br>${p.sku}</div>
      <div><strong>Namn</strong><br>${p.name}</div>
      <div><strong>Typ</strong><br>${p.type}</div>
      <div><strong>Pris</strong><br>${p.price} kr</div>
      <div><strong>Lagersaldo</strong><br>${p.stock}</div>
    </div>
    <hr>
    <em>Lagertrend (mock): +12 senaste 30 dagar.</em>
    <div style="margin-top:8px"><button class="btn small" onclick="alert('Best√§llning skapad (mock).')">Best√§ll p√•fyllning</button></div>
  `;
  openModal('Produkt ‚Ä¢ '+p.name, body, `<button class="btn" onclick="closeModal()">St√§ng</button>`);
}
function openProductModal(sku){
  const edit = !!sku;
  const p = edit ? products.find(x=>x.sku===sku) : {sku:'',name:'',type:'',price:0,stock:0};
  const body = `
    <div style="display:grid;grid-template-columns:1fr 1fr; gap:10px">
      <label>SKU<br><input id="p_sku" class="btn" value="${p.sku}"></label>
      <label>Namn<br><input id="p_name" class="btn" value="${p.name}"></label>
      <label>Typ<br><input id="p_type" class="btn" value="${p.type}"></label>
      <label>Pris<br><input id="p_price" type="number" class="btn" value="${p.price}"></label>
      <label>Lagersaldo<br><input id="p_stock" type="number" class="btn" value="${p.stock}"></label>
    </div>`;
  const footer = `
    <button class="btn" onclick="closeModal()">Avbryt</button>
    <button class="btn primary" onclick="saveProduct(${edit})">Spara</button>`;
  openModal((edit?'Redigera':'L√§gg till')+' produkt', body, footer);
  if(edit) document.getElementById('p_sku').disabled = true;
}
function saveProduct(edit){
  const p = {
    sku: (document.getElementById('p_sku').value||'').trim(),
    name:(document.getElementById('p_name').value||'').trim(),
    type:(document.getElementById('p_type').value||'').trim(),
    price:+document.getElementById('p_price').value||0,
    stock:+document.getElementById('p_stock').value||0
  };
  if(edit){
    const i = products.findIndex(x=>x.sku===p.sku);
    products[i]={...products[i], ...p};
  }else{
    products.push(p);
  }
  renderInventory(); closeModal();
}
function deleteProduct(i){
  if(confirm('Ta bort produkt?')){ products.splice(i,1); renderInventory(); }
}

/* --------------- ORDER PREVIEW + PDF -------------- */
function previewInvoice(no){
  const o = orders.find(x=>x.no===no);
  const body = `
    <div style="display:grid;grid-template-columns:1fr 1fr; gap:10px">
      <div><strong>Faktura</strong><br>${o.no}</div>
      <div><strong>Kund</strong><br>${o.customer}</div>
      <div><strong>Total</strong><br>${o.total}</div>
      <div><strong>Status</strong><br>${o.status}</div>
    </div>
    <hr>
    <em>F√∂rhandsgranskning (mock). PDF-export genererar enkel kvittofil.</em>`;
  const footer = `
    <button class="btn" onclick="closeModal()">St√§ng</button>
    <button class="btn primary" onclick="downloadPDF('${o.no}')">Ladda ner PDF</button>`;
  openModal('F√∂rhandsgranska faktura', body, footer);
}
function downloadPDF(no){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("MergX ‚Äì Faktura "+no, 20, 20);
  doc.text("Detta √§r en mock-PDF genererad i klienten.", 20, 32);
  doc.save("invoice-"+no.replace('#','')+".pdf");
}

/* --------------- FULL ORDER (mock create) -------------- */
function createOrder(){
  const n = '#'+(Math.floor(Math.random()*90000)+10000);
  orders.unshift({no:n, customer:'Nordic AB', total:'8 900 kr', status:'Skapad idag'});
  renderOrders();
  alert('Order skapad: '+n);
}

/* --------------- ECONOMY CHART + EXPORTS -------------- */
const ecoBig = new Chart(document.getElementById('ecoBig'),{
  type:'bar',
  data:{
    labels:['Jan','Feb','Mar','Apr','Maj','Jun','Jul','Aug','Sep','Okt','Nov','Dec'],
    datasets:[
      {label:'Inkomst', data:[95,102,110,120,128,140,150,160,170,175,182,196], backgroundColor:'#cfefff'},
      {label:'Utgift', data:[60,61,62,64,70,73,76,80,83,85,88,92], backgroundColor:'#eaf8f0'}
    ]
  },
  options:{ responsive:true, scales:{ y:{ beginAtZero:true } } }
});
document.getElementById('ecoRange').addEventListener('change', (e)=>{
  // enkel mock ‚Äì byt dataset
  const mode = e.target.value;
  if(mode==='month'){ ecoBig.data.labels=['v1','v2','v3','v4','v5']; }
  if(mode==='quarter'){ ecoBig.data.labels=['Q1','Q2','Q3','Q4']; }
  if(mode==='year'){ ecoBig.data.labels=['2021','2022','2023','2024','2025']; }
  ecoBig.update();
});
function exportCSV(){
  const rows = [['Period','Inkomst','Utgift']];
  ecoBig.data.labels.forEach((l,i)=>{
    const a = ecoBig.data.datasets[0].data[i]||'';
    const b = ecoBig.data.datasets[1].data[i]||'';
    rows.push([l,a,b]);
  });
  const csv = rows.map(r=>r.join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'),{href:url,download:'mergx-rapport.csv'});
  a.click(); URL.revokeObjectURL(url);
}
function exportXLSX(){ alert('Excel-export mock. (SheetJS kan kopplas senare)'); }
function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("MergX ‚Äì Ekonomirapport",20,20);
  doc.text("Period: "+document.getElementById('ecoRange').value,20,30);
  doc.text("Prognos: +3% n√§sta m√•nad (mock).",20,40);
  doc.save('mergx-rapport.pdf');
}
function sendToAuditor(){ alert('Rapport och bilagor skickade till revisor (mock).'); }
function askEcoAI(){
  const q = (document.getElementById('ecoQ').value||'').trim(); if(!q) return;
  const box = document.getElementById('ecoInsight');
  box.appendChild(Object.assign(document.createElement('div'),{className:'bubble me',textContent:q}));
  let a='Jag analyserar trenden‚Ä¶';
  if(/moms|vat/i.test(q)) a='Moms utg√•ende ~25% p√• fakturor. Nettomarginal ca 18% (mock).';
  if(/kostnad|utgift/i.test(q)) a='St√∂rst kostnadspost: ink√∂p & logistik. F√∂rslag: bundla frakter.';
  if(/balans|resultat/i.test(q)) a='Resultat positivt YTD, balans stabil. Rek. √∂ka buffert 5%.';
  box.appendChild(Object.assign(document.createElement('div'),{className:'bubble',textContent:a}));
  document.getElementById('ecoQ').value='';
}

/* --------------- GLOBAL SEARCH (Ctrl/Cmd+K) -------------- */
const gSearch = document.getElementById('globalSearch');
window.addEventListener('keydown', e=>{
  if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); gSearch.focus(); }
});
gSearch.addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    const v = gSearch.value.toLowerCase();
    if(v.includes('kund')) location.hash='#crm';
    else if(v.includes('lager')||v.includes('invent')) location.hash='#inventory';
    else if(v.includes('order')||v.includes('fakt')) location.hash='#orders';
    else if(v.includes('eko')) location.hash='#economy';
    else location.hash='#dashboard';
  }
});

/* --------------- KEY: chat enter (√§ven p√• dashboard) -------------- */
document.addEventListener('keydown', e=>{
  if(e.target.id==='aicoachInput' || e.target.id==='chatInput') return;
});

/* --------------- INITIAL FOCUS -------------- */
setTimeout(()=>{ document.getElementById('globalSearch').blur(); }, 100);
</script>
</body>
</html>
