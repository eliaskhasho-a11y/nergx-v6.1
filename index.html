<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MergX v8.20 ‚Äî Admin</title>

<!-- libs (via CDN) -->
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="dns-prefetch" href="//cdn.jsdelivr.net">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --bg:#f6f8fb; --glass:#ffffff; --text:#0f172a; --muted:#667085;
  --primary:#2563eb; --accent:#22c55e; --danger:#ef4444;
  --radius:16px; --shadow:0 10px 30px rgba(16,24,40,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text);
  font:15px/1.48 ui-sans-serif,system-ui,Segoe UI,Inter,Roboto,Helvetica,Arial;
  background:
    radial-gradient(900px 600px at 20% 10%, #e9f0ff 0%, transparent 60%),
    var(--bg);
}

/* layout */
.app{display:grid; grid-template-columns:280px 1fr; min-height:100vh; gap:24px; padding:24px}
.aside{
  position:sticky; top:24px; height:calc(100vh - 48px);
  background:linear-gradient(180deg, rgba(255,255,255,.7), rgba(255,255,255,.6));
  backdrop-filter: blur(10px);
  border:1px solid rgba(255,255,255,.6);
  border-radius:var(--radius); box-shadow:var(--shadow); padding:18px;
}
.brand{display:flex; align-items:center; gap:12px; font-weight:700; margin-bottom:8px}
.brand .dot{width:12px; height:12px; border-radius:50%; background:linear-gradient(135deg,#60a5fa,#22d3ee)}
.small{color:var(--muted); font-size:12px}
.nav{display:grid; gap:8px; margin-top:18px}
.nav a{
  display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px;
  color:var(--text); text-decoration:none; border:1px solid rgba(15,23,42,.06); background:rgba(255,255,255,.7)
}
.nav a.active{border-color:rgba(37,99,235,.25); background:#fff}
.main{display:grid; gap:24px}

/* top row kpis */
.kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:16px}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.7));
  border:1px solid rgba(255,255,255,.7); border-radius:var(--radius); box-shadow:var(--shadow);
  padding:16px; position:relative; overflow:hidden; cursor:pointer;
}
.card h4{margin:0 0 8px; color:var(--muted); font-weight:600}
.card .value{font-size:28px; font-weight:800; letter-spacing:.3px}
.badge{display:inline-block; margin-top:10px; padding:6px 10px; border-radius:999px; font-weight:600; font-size:12px; background:#eaf8ef; color:#0a7a3c}
.badge.neg{background:#eaf1ff; color:#1e429f}
.card:hover{outline:2px solid rgba(37,99,235,.18)}

/* sections */
.panel{background:linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.7));
  border:1px solid rgba(255,255,255,.7); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
.panel-head{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
.panel h3{margin:0; font-size:18px}
.actions{display:flex; gap:8px}
.btn{
  padding:8px 12px; border-radius:10px; border:1px solid rgba(15,23,42,.08);
  background:#fff; cursor:pointer; font-weight:600
}
.btn.primary{background:var(--primary); color:#fff; border-color:transparent}
.btn.ghost{background:transparent}

/* chart, map, chat grid */
.grid-2{display:grid; grid-template-columns:1.4fr .8fr; gap:16px}
.grid-2 > .panel{min-height:380px}
#econChart{width:100% !important; height:300px !important}

/* map */
#map{height:300px; border-radius:12px; overflow:hidden}

/* chat */
.chat-wrap{display:grid; grid-template-rows:1fr auto; height:300px}
.chat-log{overflow:auto; display:grid; gap:10px; padding-right:6px}
.msg{max-width:70%; padding:10px 12px; border-radius:14px; background:#eef2ff}
.msg.me{margin-left:auto; background:#e0ebff}
.chat-input{display:flex; gap:8px; align-items:center; margin-top:10px}
.chat-input input{
  flex:1; padding:12px 14px; border-radius:12px; border:1px solid rgba(15,23,42,.1); background:#fff
}
.icon-btn{
  width:40px; height:40px; display:grid; place-items:center; border-radius:10px;
  border:1px solid rgba(15,23,42,.08); background:#fff; cursor:pointer
}

/* modal */
.modal{
  position:fixed; inset:0; background:rgba(15,23,42,.25);
  display:none; align-items:center; justify-content:center; padding:24px; z-index:50
}
.modal.show{display:flex}
.modal .box{max-width:740px; width:100%; background:#fff; border-radius:16px; box-shadow:var(--shadow); padding:18px}
.modal .box h3{margin:0 0 8px}
.modal .box .ai{white-space:pre-wrap; color:#111827}

/* responsive */
@media (max-width:1100px){ .kpis{grid-template-columns:repeat(2,1fr)} .grid-2{grid-template-columns:1fr} }
@media (max-width:680px){
  .app{grid-template-columns:1fr; padding:12px}
  .aside{position:static; height:auto}
  .kpis{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="app">

  <!-- SIDOPANEL -->
  <aside class="aside">
    <div class="brand"><span class="dot"></span> MergX Admin <span class="small">v8.20 ‚Ä¢ Light + Glass</span></div>
    <nav class="nav" id="nav">
      <a href="#dash" class="active">√ñversikt</a>
      <a href="#orders">Ordrar & fakturor</a>
      <a href="#crm">Kunder (CRM)</a>
      <a href="#inv">Inventarie</a>
      <a href="#staff">Anst√§llda</a>
      <a href="#files">Filer & kvitton</a>
      <a href="#aimap">AI-karta</a>
      <a href="#chat">Chatt</a>
      <a href="#settings">Inst√§llningar</a>
    </nav>
  </aside>

  <!-- HUVUDINNEH√ÖLL -->
  <main class="main" id="dash">
    <!-- S√∂kf√§lt -->
    <div class="panel" style="padding:10px 16px">
      <input id="globalSearch" placeholder="S√∂k i MergX‚Ä¶ (kunder, order, produkter)" style="width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(15,23,42,.12); background:#fff">
    </div>

    <!-- KPI-kort -->
    <section class="kpis" id="kpis">
      <div class="card" data-kpi="revenue">
        <h4>Oms√§ttning (idag)</h4>
        <div class="value" id="revVal">124 500 kr</div>
        <div class="badge" id="revDelta">+6.2%</div>
      </div>
      <div class="card" data-kpi="orders">
        <h4>Order idag</h4>
        <div class="value" id="ordVal">37</div>
        <div class="badge" id="ordDelta">+4</div>
      </div>
      <div class="card" data-kpi="costs">
        <h4>Kostnader (idag)</h4>
        <div class="value" id="costVal">48 900 kr</div>
        <div class="badge neg" id="costDelta">‚Äì2.1%</div>
      </div>
      <div class="card" data-kpi="margin">
        <h4>Bruttomarginal</h4>
        <div class="value" id="gmVal">41.5%</div>
        <div class="badge" id="gmDelta">+0.7 pp</div>
      </div>
    </section>

    <!-- Graf + Karta -->
    <section class="grid-2">
      <div class="panel">
        <div class="panel-head">
          <h3>Ekonomi ‚Äî kombostaplar</h3>
          <div class="actions">
            <button class="btn ghost" data-ask="econ">Ask AI</button>
            <button class="btn" id="expandChart">Expandera</button>
          </div>
        </div>
        <canvas id="econChart"></canvas>
      </div>

      <div class="panel" id="aimap">
        <div class="panel-head">
          <h3>AI-karta (mini)</h3>
          <div class="actions">
            <button class="btn ghost" data-ask="map">Ask AI</button>
            <button class="btn" id="expandMap">Expandera</button>
          </div>
        </div>
        <div id="map"></div>
        <div class="small" id="routeNote" style="margin-top:8px">
          AI-rekommendation (mock): ‚ÄúBes√∂k <b>Elon Kista</b> ‚Üí <b>Power Solna</b> ‚Üí <b>Mekonomen Bromma</b>. Totalt ca 43 min.‚Äù
        </div>
      </div>
    </section>

    <!-- Chatt + Orderlista (kompakt) -->
    <section class="grid-2">
      <div class="panel">
        <div class="panel-head">
          <h3>Teamchatt</h3>
          <div class="actions">
            <button class="btn ghost" data-ask="chat">Ask AI</button>
            <button class="btn" id="expandChat">Expandera</button>
          </div>
        </div>
        <div class="chat-wrap">
          <div class="chat-log" id="chatLog">
            <div class="msg">God morgon teamet!</div>
            <div class="msg me">Jag tar kundm√∂tet 11:00.</div>
          </div>
          <div class="chat-input">
            <button class="icon-btn" id="attachBtn" title="L√§gg till fil">üìé</button>
            <button class="icon-btn" id="micBtn" title="Spela in r√∂st">üé§</button>
            <input id="chatInput" placeholder="Skriv ett meddelande‚Ä¶ (Enter f√∂r att skicka)" />
            <button class="btn primary" id="sendBtn">Skicka</button>
            <input type="file" id="fileHidden" hidden>
          </div>
        </div>
        <div class="small" id="voiceNote" style="margin-top:6px;color:#475569">
          R√∂stinspelning sparas lokalt (mock). AI-sammanfattning per kund i kommande version.
        </div>
      </div>

      <div class="panel">
        <div class="panel-head"><h3>Ordrar & fakturor ‚Äî senast</h3></div>
        <div class="small">#10234 ‚Ä¢ Acme AB ‚Ä¢ 24 900 kr ‚Ä¢ Skapad idag &nbsp;&nbsp;|&nbsp;&nbsp; #10231 ‚Ä¢ Elon City ‚Ä¢ 12 200 kr ‚Ä¢ Skapad ig√•r</div>
        <div class="small" style="margin-top:10px">PDF-export (jsPDF) kopplas i n√§sta sprint.</div>
      </div>
    </section>

  </main>
</div>

<!-- KPI-ANALYS MODAL -->
<div class="modal" id="modal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <h3 id="modalTitle">Analys</h3>
      <button class="btn" id="closeModal">St√§ng</button>
    </div>
    <div class="ai" id="modalBody"></div>
  </div>
</div>

<script>
/* --------- helper --------- */
const $ = (q,ctx=document)=>ctx.querySelector(q);
const $$ = (q,ctx=document)=>[...ctx.querySelectorAll(q)];

/* --------- nav active --------- */
$('#nav').addEventListener('click', e=>{
  if(e.target.tagName!=='A') return;
  $$('#nav a').forEach(a=>a.classList.remove('active'));
  e.target.classList.add('active');
});

/* --------- KPI cards -> modal AI --------- */
const modal = $('#modal'), mTitle = $('#modalTitle'), mBody = $('#modalBody');
$('#closeModal').onclick = ()=> modal.classList.remove('show');

const aiExplainers = {
  revenue:`‚Ä¢ Oms√§ttning +6.2% vs ig√•r.\n‚Ä¢ Drivet av 3 st√∂rre B2B-ordrar.\n‚Ä¢ Prognos: +8‚Äì10% vecka.\n‚Ä¢ Rek: tryck kampanj mot topp-3 artiklar.`,
  orders:`‚Ä¢ 37 ordrar idag, +4 mot rullande snitt.\n‚Ä¢ B2B-andel 32%.\n‚Ä¢ Rek: ring upp ‚Äúvarma‚Äù kundkort i CRM f√∂r h√∂gre snitt.`,
  costs:`‚Ä¢ Kostnader -2.1% (bra!).\n‚Ä¢ H√∂gst: frakt & returer.\n‚Ä¢ Rek: batcha etiketter och f√∂rhandla zon-priser.`,
  margin:`‚Ä¢ GM 41.5% (+0.7pp).\n‚Ä¢ Vinnare: USB-C 60W, Bil-laddare 60W.\n‚Ä¢ Rek: h√∂j 3% p√• topp-s√§lj utan tapp.`
};

$('#kpis').addEventListener('click', e=>{
  const card = e.target.closest('.card'); if(!card) return;
  const k = card.dataset.kpi;
  mTitle.textContent = `AI-analys ‚Äî ${({'revenue':'Oms√§ttning','orders':'Order','costs':'Kostnader','margin':'Bruttomarginal'})[k]||''}`;
  mBody.textContent = aiExplainers[k] || '‚Äî';
  modal.classList.add('show');
});

/* --------- Ask AI knappar i paneler (mock) --------- */
$$('[data-ask]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const what = btn.getAttribute('data-ask');
    mTitle.textContent = `AI-analys ‚Äî ${what==='econ'?'Ekonomi':what==='map'?'Karta':what==='chat'?'Chatt':'Modul'}`;
    mBody.textContent =
      what==='econ' ? '‚Ä¢ S√§songs¬≠effekt v4‚Üív5.\n‚Ä¢ Rek: kampanj inf√∂r helg, 12% rabatt p√• bundle.\n‚Ä¢ Prognos n√§sta vecka +5%.' :
      what==='map'  ? '‚Ä¢ F√∂resl√•r rutt: Elon Kista ‚Üí Power Solna ‚Üí Mekonomen Bromma.\n‚Ä¢ Undvik Essingeleden 08‚Äì09.\n‚Ä¢ L√§gg notis: ‚ÄúElon Kista vill k√∂pa om 20 dagar‚Äù.' :
      '‚Ä¢ Fler mentions kring ‚Äúleverans‚Äù.\n‚Ä¢ Rek: skicka sammanfattning till Ekonomi & Lager.';
    modal.classList.add('show');
  });
});

/* --------- Chart --------- */
let econChart;
function initChart(){
  const ctx = $('#econChart');
  econChart = new Chart(ctx, {
    type:'bar',
    data:{
      labels:['v1','v2','v3','v4','v5'],
      datasets:[
        {label:'Oms√§ttning', data:[100,120,90,140,160], backgroundColor:'#a5b4fc'},
        {label:'Kostnader',  data:[50,60,45,60,70],    backgroundColor:'#c7d2fe'},
        {label:'Brutto%',    data:[60,62,61,62,66],    type:'line', borderColor:'#3b82f6', backgroundColor:'transparent', tension:.3}
      ]
    },
    options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{boxWidth:14}}}, scales:{y:{beginAtZero:true}}}
  });
}
initChart();
$('#expandChart').onclick = ()=>{
  mTitle.textContent='Ekonomi ‚Äî detaljer';
  mBody.innerHTML = '‚Ä¢ v5 stark p.g.a. B2B-order.\n‚Ä¢ Rek: f√∂lj upp topp-3 kunder.\n‚Ä¢ Prognos: +7% n√§sta vecka.';
  modal.classList.add('show');
};

/* --------- Map (Leaflet) --------- */
let map;
function initMap(){
  map = L.map('map',{zoomControl:true}).setView([59.334591,18.06324], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'&copy; OpenStreetMap'
  }).addTo(map);
  const pin = L.marker([59.403, 17.944]).addTo(map);
  pin.bindPopup('Rek. f√∂rsta stopp: <b>Elon Kista</b>').openPopup();

  // Geolocation (om till√•tet)
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      map.setView([pos.coords.latitude, pos.coords.longitude], 12);
    });
  }
}
initMap();
$('#expandMap').onclick = ()=>{
  mTitle.textContent='AI-karta ‚Äî rekommendationer';
  mBody.innerHTML='‚Ä¢ F√∂resl√•r rutt: Elon Kista ‚Üí Power Solna ‚Üí Mekonomen Bromma.\n‚Ä¢ Total restid ca 43 min.\n‚Ä¢ L√§gg plats-notiser per stopp.';
  modal.classList.add('show');
};

/* --------- Chatt --------- */
const chatLog = $('#chatLog'), chatInput=$('#chatInput'), sendBtn=$('#sendBtn');
function pushMsg(txt,me=false){
  const d=document.createElement('div'); d.className='msg'+(me?' me':''); d.textContent=txt;
  chatLog.appendChild(d); chatLog.scrollTop=chatLog.scrollHeight;
}
sendBtn.onclick = ()=>{ if(!chatInput.value.trim())return; pushMsg(chatInput.value,true); chatInput.value=''; };
chatInput.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); sendBtn.click(); }});

$('#attachBtn').onclick = ()=>$('#fileHidden').click();
$('#fileHidden').onchange = (e)=>{
  const f = e.target.files[0]; if(!f) return; pushMsg(`üìé Bilaga: ${f.name}`);
};

/* R√∂st (mock via MediaRecorder om finns) */
let mediaRecorder, chunks=[];
$('#micBtn').onclick = async ()=>{
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e=> chunks.push(e.data);
    mediaRecorder.onstop = ()=>{
      const blob = new Blob(chunks, {type:'audio/webm'}); chunks=[];
      const url = URL.createObjectURL(blob);
      pushMsg(`üé§ R√∂stanteckning sparad (lokalt).`); // kunde l√§nkas: <audio controls src="url">
    };
    mediaRecorder.start();
    pushMsg('üéôÔ∏è Inspelning startad‚Ä¶ klicka igen f√∂r att stoppa.');
    $('#micBtn').onclick = ()=>{ mediaRecorder.stop(); $('#micBtn').onclick = async ()=>{ /* re-arm */ }; };
  }catch(err){
    pushMsg('üé§ Mikrofon ej till√•ten ‚Äî sparar som mock.');
  }
};

$('#expandChat').onclick = ()=>{
  mTitle.textContent='Teamchatt ‚Äî analys';
  mBody.textContent='‚Ä¢ Fler mentions kring ‚Äúleverans‚Äù i morse.\n‚Ä¢ Rek: skicka auto-sammanfattning till Ekonomi & Lager.';
  modal.classList.add('show');
};
</script>
</body>
</html>
