<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MergX v8.17 ‚Ä¢ Admin (Full, Light+Glass)</title>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<!-- Chart.js & Leaflet (CDN, no build) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --bg:#F6F8FB;
  --glass:rgba(255,255,255,.72);
  --frost:blur(14px) saturate(150%);
  --border:rgba(15,23,42,.08);
  --text:#0F172A;
  --muted:#667085;
  --brand:#1F9DFF;
  --turq:#00D2C6;
  --red:#EF4444;
  --blue:#3B82F6;
  --shadow:0 12px 28px rgba(15,23,42,.08);
  --radius:16px; --gap:20px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
  background:
    radial-gradient(1200px 600px at 10% -10%, #EAF4FF, transparent 50%),
    radial-gradient(1000px 600px at 120% 0%, #F5FFFB, transparent 50%),
    var(--bg);
}
a{text-decoration:none;color:inherit}

.app{
  display:grid; grid-template-columns: 260px 1fr; gap:0; min-height:100dvh;
}

/* Sidebar */
.sidebar{
  position:sticky; top:0; align-self:start; height:100dvh; overflow:auto;
  background:var(--glass); backdrop-filter:var(--frost); -webkit-backdrop-filter:var(--frost);
  border-right:1px solid var(--border);
}
.brand{ display:flex; align-items:center; gap:10px; padding:18px 16px }
.brand .dot{ width:12px; height:12px; border-radius:50%;
  background:radial-gradient(circle at 30% 30%, #b0d7ff, #7fc8ff 40%, #7c7cff);
  box-shadow:0 0 18px rgba(124,124,255,.5);
  animation:pulse 2.8s ease-in-out infinite;
}
@keyframes pulse{0%{box-shadow:0 0 10px rgba(124,124,255,.5)}50%{box-shadow:0 0 24px rgba(124,124,255,.7)}100%{box-shadow:0 0 10px rgba(124,124,255,.5)}}
.nav{ padding:8px }
.nav a{
  display:flex; align-items:center; gap:10px; padding:10px 14px; margin:6px 8px; border-radius:12px; font-weight:600;
  border:1px solid transparent;
}
.nav a.active, .nav a:hover{ background:rgba(255,255,255,.9); border-color:var(--border); box-shadow:var(--shadow) }

/* Topbar */
.topbar{
  position:sticky; top:0; z-index:50; background:transparent;
}
.topbar-wrap{
  display:flex; align-items:center; gap:14px; padding:14px 18px;
  background:var(--glass); backdrop-filter:var(--frost); -webkit-backdrop-filter:var(--frost);
  border-bottom:1px solid var(--border);
}
.search{
  flex:1; display:flex; align-items:center; gap:10px; padding:10px 12px;
  border:1px solid var(--border); border-radius:12px; background:#fff;
}
.search input{ flex:1; border:0; outline:0; font-size:14px }
.badge{
  position:relative; width:40px; height:40px; display:grid; place-items:center; border-radius:12px; background:#fff; border:1px solid var(--border)
}
.badge .n{ position:absolute; top:-6px; right:-6px; background:#E11D48; color:#fff; font-size:11px; width:18px; height:18px; border-radius:999px; display:grid; place-items:center; font-weight:800 }

/* Main */
.main{ padding:20px; }
.grid{ display:grid; gap:var(--gap) }
.kpis{ grid-template-columns: repeat(4, 1fr) }
.card{
  background:var(--glass); backdrop-filter:var(--frost); -webkit-backdrop-filter:var(--frost);
  border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
  padding:18px; position:relative; overflow:hidden;
}
.title{ font-size:13px; color:var(--muted); font-weight:700; letter-spacing:.02em }
.metric{ font-size:30px; font-weight:800; margin:6px 0 10px }
.progress{ height:28px; border:1px solid var(--border); border-radius:12px; background:#F3FAF7; overflow:hidden }
.progress > span{ display:block; height:100%; border-radius:12px }
.pill{ display:inline-block; padding:4px 10px; border-radius:999px; background:#ECFDF3; color:#065F46; font-weight:700; font-size:12px }

/* Sections */
.two{ grid-template-columns: 1.3fr 1fr }
.row2{ display:grid; grid-template-columns: 1fr 1fr; gap:var(--gap) }
.subhead{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px }
.subhead h3{ margin:0; font-size:16px; font-weight:800 }
.btn{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer; }
.btn.link{ background:transparent; border:0; color:var(--blue) }
.table{ overflow:auto; border:1px solid var(--border); border-radius:12px; background:#fff }
table{ width:100%; border-collapse:collapse; font-size:14px }
th,td{ padding:11px 12px; border-bottom:1px solid #EEF2F7; text-align:left }
th{ color:#64748B; font-weight:800 }
.tag{ font-size:12px; padding:4px 8px; border-radius:999px; background:#EFF8FF; color:#175CD3; font-weight:800 }

/* Chat widget */
.chatbox{
  position:fixed; right:22px; bottom:22px; width:360px; max-width:94vw; height:480px; display:flex; flex-direction:column;
  background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:0 20px 40px rgba(15,23,42,.18); z-index:60;
}
.chatbox header{ padding:10px 14px; background:linear-gradient(180deg,#BEE9FF,#9EDCFF); font-weight:800; border-radius:18px 18px 0 0 }
.chat-messages{ flex:1; overflow:auto; padding:12px }
.msg{ max-width:78%; padding:10px 14px; border-radius:14px; margin:6px 0; line-height:1.35 }
.msg.ai{ background:#EAF4FF; color:#0f2640 }
.msg.me{ background:linear-gradient(180deg,#B5E4FF,#9ADCFB); color:#082a3a; margin-left:auto }
.chat-input{ display:flex; gap:8px; border-top:1px solid #E5E7EB; padding:8px }
.chat-input input{ flex:1; border:1px solid var(--border); border-radius:10px; padding:10px 12px; outline:0 }
.iconbtn{ height:36px; aspect-ratio:1; display:grid; place-items:center; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer }

/* Expand Sheet (in-place) */
.overlay{ position:fixed; inset:0; display:none; align-items:flex-end; justify-content:center; background:rgba(15,23,42,.4); z-index:55 }
.sheet{
  width:min(1040px,96vw); max-height:88vh; overflow:auto; background:var(--glass); backdrop-filter:var(--frost);
  border:1px solid var(--border); border-radius:18px; padding:18px; margin:24px; box-shadow:0 40px 80px rgba(15,23,42,.35)
}
.sheet .head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px }
.sheet .head h3{ margin:0; font-size:18px; font-weight:900 }

/* Coach pulse */
.coach-pulse{ position:absolute; right:14px; top:14px; width:10px; height:10px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #9EE7FF, #7DCBFF 60%, #7C79FF); box-shadow:0 0 12px rgba(124,121,255,.7); animation:pulse2 2.8s ease-in-out infinite }
@keyframes pulse2{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}

/* Map */
#mapMini, #mapBig{ height:300px; border-radius:12px; border:1px solid var(--border); overflow:hidden }

/* Responsive */
@media (max-width:1200px){ .kpis{ grid-template-columns:1fr 1fr } .two{ grid-template-columns:1fr } }
</style>
</head>
<body>

<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <div style="font-weight:900;letter-spacing:.2px">MergX Admin</div>
        <div style="font-size:12px;color:var(--muted)">v8.17 ‚Ä¢ Light + Glass</div>
      </div>
    </div>
    <nav class="nav" id="nav">
      <a href="#/dashboard" data-route><span>üè†</span> √ñversikt</a>
      <a href="#/orders" data-route><span>üßæ</span> Ordrar & fakturor</a>
      <a href="#/customers" data-route><span>üë•</span> Kunder (CRM)</a>
      <a href="#/inventory" data-route><span>üì¶</span> Inventarie</a>
      <a href="#/employees" data-route><span>üë§</span> Anst√§llda</a>
      <a href="#/files" data-route><span>üóÇÔ∏è</span> Filer & kvitton</a>
      <a href="#/map" data-route><span>üó∫Ô∏è</span> AI-karta</a>
      <a href="#/chat" data-route><span>üí¨</span> Chatt</a>
      <a href="#/settings" data-route><span>‚öôÔ∏è</span> Inst√§llningar</a>
    </nav>
  </aside>

  <!-- MAIN -->
  <main>
    <!-- TOPBAR -->
    <div class="topbar" id="topbar">
      <div class="topbar-wrap" id="topbarWrap">
        <div class="search" id="searchBar">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.2-4.2m1.7-5.3a7 7 0 11-14 0 7 7 0 0114 0z" stroke="#64748B" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="globalSearch" placeholder="S√∂k kunder, order, artiklar‚Ä¶" />
          <button class="btn" onclick="go('#/dashboard')">G√• till √ñversikt</button>
        </div>
        <div class="badge" onclick="openNotis()">
          üîî <div class="n" id="notisCount">3</div>
        </div>
      </div>
    </div>

    <!-- ROUTER VIEW -->
    <div class="main">
      <div id="view"></div>
    </div>
  </main>
</div>

<!-- EXPAND SHEET -->
<div class="overlay" id="overlay" onclick="if(event.target===this)closeSheet()">
  <div class="sheet">
    <div class="head">
      <h3 id="sheetTitle">Detaljer</h3>
      <button class="btn" onclick="closeSheet()">St√§ng</button>
    </div>
    <div id="sheetBody"></div>
  </div>
</div>

<!-- FLOATING CHAT -->
<div class="chatbox" id="chatbox">
  <header>üí¨ MergX Chatt & AI</header>
  <div class="chat-messages" id="chatMsgs"></div>
  <div class="chat-input">
    <button class="iconbtn" title="Emoji">üòä</button>
    <button class="iconbtn" title="Bilaga (mock)">üìé</button>
    <input id="chatInput" placeholder="Skriv meddelande‚Ä¶ (Enter skickar)" />
    <button class="iconbtn" title="Skicka" onclick="sendChat()">‚û°Ô∏è</button>
  </div>
</div>

<script>
/* ---------------- State & Helpers ---------------- */
const $ = s => document.querySelector(s);
const $$$ = s => document.querySelectorAll(s);
const store = {
  get(k,f){ try{return JSON.parse(localStorage.getItem(k)) ?? f}catch{return f} },
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
};
function go(hash){ location.hash = hash; }

/* Demo data (mock) */
const DATA = {
  kpi:{ revenue:124500, orders:37, cost:48900, margin:41.5 },
  orders: store.get('orders', [
    {nr:'#10234', kund:'Acme AB', total:'24 900 kr', status:'Skapad idag', datum:'2025-11-03'},
    {nr:'#10231', kund:'Elon City', total:'12 200 kr', status:'Skapad ig√•r', datum:'2025-11-02'}
  ]),
  customers: store.get('customers', [
    {id:'C001', namn:'Elon Kista', kontakt:'Sara Nilsson', email:'sara@elon.se', tel:'070-123 45 67', stad:'Kista', notis:'K√∂p om 20 dagar'},
    {id:'C002', namn:'Power Solna', kontakt:'Johan Eriksen', email:'johan@power.se', tel:'070-222 33 44', stad:'Solna', notis:''},
  ]),
  inventory: store.get('inventory', [
    {sku:'A60W-USB-C', namn:'USB-C Laddare 60W', typ:'Laddare', antal:42, inkop:149, pris:299, status:'OK'},
    {sku:'C2C-60W-1m', namn:'USB-C till USB-C 1m', typ:'Kabel', antal:18, inkop:39, pris:129, status:'Bristsaldo'},
  ]),
  employees: store.get('employees', [
    {id:'E001', namn:'Lina Berg', roll:'S√§lj', email:'lina@mergx.se', tel:'070-111 22 33', form:'Heltid', start:'2025-08-01'},
    {id:'E002', namn:'Ali Noor', roll:'Ekonomi', email:'ali@mergx.se', tel:'070-444 55 66', form:'Provanst', start:'2025-10-10'}
  ]),
  files: store.get('files', [
    {id:'F001', namn:'kvitto_2025-10-30.jpg', tag:'kvitto'},
    {id:'F002', namn:'avtal_Elon.pdf', tag:'avtal'}
  ]),
  notis: store.get('notis', [
    'üîî Ny order #10234 skapades',
    'üßæ PDF-faktura mock genererad',
    'üó∫Ô∏è AI-rutt uppdaterad (demo)'
  ]),
  settings: store.get('settings', {
    theme:'light', lang:'sv',
    company:{ namn:'MergX AB', orgnr:'556677-8899', addr:'Sveav√§gen 12, 111 57 Stockholm', email:'info@mergx.se' },
    api:{ fraktjakt:'', finans:'', whatsapp:'', sms:'', ai_engine:'mock' }
  })
};

/* ---------------- Router ---------------- */
const routes = {
  '/dashboard': renderDashboard,
  '/orders': renderOrders,
  '/customers': renderCustomers,
  '/inventory': renderInventory,
  '/employees': renderEmployees,
  '/files': renderFiles,
  '/map': renderMapPage,
  '/chat': renderChatPage,
  '/settings': renderSettings
};
function router(){
  const hash = location.hash.replace('#','') || '/dashboard';
  // activate nav
  $$$('[data-route]').forEach(a=> a.classList.toggle('active', a.getAttribute('href')==='#'+hash));
  const view = $('#view'); view.innerHTML='';
  (routes[hash]||renderDashboard)(view);
}
window.addEventListener('hashchange', router);
window.addEventListener('load', router);

/* ---------------- Components ---------------- */
function kpiCard(title, metric, pct, good=true){
  const color = good? '#DCFCE7':'#EEF2FF';
  return `
  <div class="card">
    <div class="title">${title}</div>
    <div class="metric">${metric}</div>
    <div class="progress"><span style="width:${Math.min(Math.abs(pct),100)}%;background:${color}"></span></div>
    <div class="pill" style="margin-top:8px">${good?'+':''}${pct}%</div>
  </div>`;
}

/* ---------------- Dashboard ---------------- */
function renderDashboard(root){
  root.innerHTML = `
    <section class="grid kpis">
      ${kpiCard('Oms√§ttning idag', fmtKr(DATA.kpi.revenue), 82, true)}
      ${kpiCard('Order idag', DATA.kpi.orders, 64, true)}
      ${kpiCard('Kostnader (idag)', fmtKr(DATA.kpi.cost), 76, false)}
      ${kpiCard('Bruttomarginal', DATA.kpi.margin+' %', 90, true)}
    </section>

    <section class="grid two">
      <div class="grid" style="gap:var(--gap)">
        <div class="card" id="ecoCard">
          <div class="subhead">
            <h3>Ekonomi ‚Äî kombostaplar</h3>
            <div>
              <button class="btn link" onclick="openEcoDetail()">Expandera</button>
            </div>
          </div>
          <div style="height:340px"><canvas id="ecoChart"></canvas></div>
          <div class="title" style="margin-top:8px"><strong>AI-analys:</strong> Oms√§ttningen √§r +6% mot snittet. St√∂rst √∂kning hos Power Solna.</div>
        </div>

        <div class="card" id="chatCard">
          <div class="subhead">
            <h3>Teamchatt (snabbvy)</h3>
            <button class="btn link" onclick="openChatDetail()">Expandera</button>
          </div>
          <div id="dashChat" style="max-height:220px; overflow:auto"></div>
          <div style="display:flex; gap:8px; margin-top:8px">
            <input id="dashChatInput" placeholder="Skriv‚Ä¶ (Enter skickar)" style="flex:1; border:1px solid var(--border); border-radius:10px; padding:10px 12px" />
            <button class="btn" onclick="dashChatSend()">Skicka</button>
          </div>
        </div>

        <div class="card" id="ordersCard">
          <div class="subhead">
            <h3>Ordrar & fakturor</h3>
            <div class="title">√Ötg√§rder: üëÅ f√∂rhandsvisa ‚Ä¢ üßæ PDF</div>
          </div>
          <div class="table"><table>
            <thead><tr><th>Nr</th><th>Kund</th><th>Total</th><th>Status</th><th style="text-align:right">√Ötg√§rder</th></tr></thead>
            <tbody id="orderTBody"></tbody>
          </table></div>
        </div>
      </div>

      <div class="grid" style="gap:var(--gap)">
        <div class="card" id="mapCard">
          <div class="subhead">
            <h3>AI-karta (mini, GPS)</h3>
            <div>
              <button class="btn" onclick="askAiRoute()">‚ú® Ask AI</button>
              <button class="btn link" onclick="openMapDetail()">Expandera</button>
            </div>
          </div>
          <div id="mapMini"></div>
          <div class="title" style="margin-top:8px">
            <strong>F√∂rslag:</strong> Elon Kista ‚Üí Power Solna ‚Üí Mekonomen Bromma (‚âà 43 min)
          </div>
        </div>

        <div class="card" id="coachCard" style="position:relative">
          <div class="coach-pulse"></div>
          <div class="subhead"><h3>AI-Coach</h3><button class="btn link" onclick="openCoachDetail()">Expandera</button></div>
          <div class="title">Hej üëã Jag √∂vervakar siffrorna. Vill du ha veckorapport nu?</div>
        </div>

        <div class="card" id="notisCard">
          <div class="subhead"><h3>Notiser</h3></div>
          <ul id="notisList" style="margin:0; padding-left:18px"></ul>
        </div>
      </div>
    </section>
  `;
  // chart
  const ctx = document.getElementById('ecoChart');
  new Chart(ctx, {
    type:'bar',
    data:{
      labels:['v1','v2','v3','v4','v5'],
      datasets:[
        {label:'Oms√§ttning', data:[100,140,90,130,160], backgroundColor:'#CFEAFF', borderRadius:8},
        {label:'Kostnader', data:[40,65,45,60,70], backgroundColor:'#FEE2E2', borderRadius:8},
        {label:'Brutto%', data:[40,42,40,41,42], type:'line', yAxisID:'y1', borderColor:'#3B82F6', borderWidth:2, tension:.3, pointRadius:0}
      ]
    },
    options:{ maintainAspectRatio:false, scales:{ y1:{position:'right', ticks:{ callback:v=>v+'%'}}}}
  });
  // orders
  renderOrdersRows('#orderTBody');
  // dash chat
  renderDashChat();
  $('#dashChatInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); dashChatSend(); }});
  // notiser
  renderNotis('#notisList');
  // map
  initMapMini();
}

/* ---------------- Orders View ---------------- */
function renderOrders(root){
  root.innerHTML = `
    <section class="grid">
      <div class="card">
        <div class="subhead"><h3>Ordrar & fakturor</h3>
          <div><button class="btn" onclick="openCreateOrder()">+ Skapa order</button></div>
        </div>
        <div class="table"><table>
          <thead><tr><th>Nr</th><th>Kund</th><th>Total</th><th>Status</th><th>Datum</th><th style="text-align:right">√Ötg√§rder</th></tr></thead>
          <tbody id="orderTBody2"></tbody>
        </table></div>
      </div>
    </section>
  `;
  renderOrdersRows('#orderTBody2');
}
function renderOrdersRows(sel){
  const tb = document.querySelector(sel); tb.innerHTML='';
  DATA.orders.forEach(o=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${o.nr}</td><td>${o.kund}</td><td>${o.total}</td><td><span class="tag">${o.status}</span></td><td>${o.datum ?? ''}</td>
      <td style="text-align:right;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" onclick="previewInvoice('${o.nr}')">üëÅ</button>
        <button class="btn" onclick="downloadPdf('${o.nr}')">üßæ</button>
      </td>`;
    tb.appendChild(tr);
  });
}
function openCreateOrder(){
  openSheet('Skapa order', `
    <div class="title">V√§lj kund</div>
    <select id="orderCustomer" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;margin:6px 0 12px">
      ${DATA.customers.map(c=>`<option value="${c.id}">${c.namn}</option>`).join('')}
    </select>
    <div class="title">L√§gg till produkter</div>
    <div style="display:flex; gap:8px; margin:6px 0">
      <select id="orderItem" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:10px">
        ${DATA.inventory.map(i=>`<option value="${i.sku}">${i.sku} ‚Äî ${i.namn}</option>`).join('')}
      </select>
      <input id="orderQty" type="number" min="1" value="1" style="width:90px;padding:10px;border:1px solid var(--border);border-radius:10px">
      <button class="btn" onclick="addOrderLine()">L√§gg till rad</button>
    </div>
    <div id="orderLines" class="table" style="margin:8px 0"><table><thead><tr><th>Artikel</th><th>Antal</th></tr></thead><tbody></tbody></table></div>
    <div class="title">Betalningsvillkor</div>
    <input id="orderNetDays" type="number" min="0" value="30" style="width:120px;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div style="display:flex; gap:8px; margin-top:12px">
      <button class="btn" onclick="mockSaveOrder()">Spara order</button>
      <button class="btn" onclick="previewInvoice('NY')">F√∂rhandsvisa faktura</button>
    </div>
  `);
}
const tempOrder = [];
function addOrderLine(){
  const sku = $('#orderItem').value;
  const qty = parseInt($('#orderQty').value||'1',10);
  tempOrder.push({sku, qty});
  const tbody = $('#orderLines tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${sku}</td><td>${qty}</td>`;
  tbody.appendChild(tr);
}
function mockSaveOrder(){
  const custId = $('#orderCustomer').value;
  const cust = DATA.customers.find(c=>c.id===custId);
  const nr = '#10' + (200 + DATA.orders.length);
  DATA.orders.unshift({nr, kund:cust.namn, total:'‚Äî', status:'Skapad', datum:new Date().toISOString().slice(0,10)});
  store.set('orders', DATA.orders);
  closeSheet(); router(); alert('Order sparad (mock).');
}
function previewInvoice(nr){
  openSheet('Faktura ‚Äî f√∂rhandsvisning', `
    <div class="card" style="background:#fff">
      <h3 style="margin:6px 0">Faktura ${nr}</h3>
      <div class="title">${DATA.settings.company.namn} ‚Ä¢ Orgnr ${DATA.settings.company.orgnr}</div>
      <hr style="border:none;border-top:1px solid #EEE;margin:12px 0">
      <div>Rad 1 ‚Äî Produkt A ‚Äî 4 st ‚Äî 1 990 kr</div>
      <div>Rad 2 ‚Äî Produkt B ‚Äî 2 st ‚Äî 1 290 kr</div>
      <div style="text-align:right;margin-top:10px;font-weight:900">Summa: 24 900 kr</div>
    </div>
    <div class="title" style="margin-top:10px"><strong>AI-tips:</strong> f√∂resl√•r 30 dagar netto och automatisk h√§lsning i utskick.</div>
  `);
}
function downloadPdf(nr){
  alert('PDF-mock: Faktura '+nr+' genereras i n√§sta version (jsPDF).');
}

/* ---------------- Customers (CRM) ---------------- */
function renderCustomers(root){
  root.innerHTML = `
    <section class="grid">
      <div class="card">
        <div class="subhead">
          <h3>Kunder</h3>
          <div><button class="btn" onclick="openCreateCustomer()">+ L√§gg till kund</button></div>
        </div>
        <div class="table"><table>
          <thead><tr><th>ID</th><th>F√∂retag</th><th>Kontakt</th><th>E-post</th><th>Telefon</th><th>Stad</th><th>Notis</th></tr></thead>
          <tbody id="custBody"></tbody>
        </table></div>
      </div>
    </section>
  `;
  const tb = $('#custBody');
  DATA.customers.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td><a href="javascript:void(0)" onclick="openCustomer('${c.id}')">${c.id}</a></td>
      <td>${c.namn}</td><td>${c.kontakt}</td><td>${c.email}</td><td>${c.tel}</td><td>${c.stad}</td><td>${c.notis||''}</td>`;
    tb.appendChild(tr);
  });
}
function openCustomer(id){
  const c = DATA.customers.find(x=>x.id===id);
  openSheet('Kund ‚Äî '+c.namn, `
    <div class="title">Kontakt: ${c.kontakt} ‚Ä¢ ${c.email} ‚Ä¢ ${c.tel}</div>
    <div class="title">Ort: ${c.stad}</div>
    <div class="title">Notis: ${c.notis||'‚Äî'}</div>
    <hr style="border:none;border-top:1px solid #EEF2F7;margin:12px 0">
    <div style="display:flex; gap:8px">
      <button class="btn" onclick="editCustomer('${c.id}')">√Ñndra</button>
      <button class="btn" onclick="deleteCustomer('${c.id}')">Ta bort</button>
    </div>
  `);
}
function openCreateCustomer(){
  openSheet('Ny kund', `
    <div class="title">F√∂retagsnamn</div><input id="c_namn" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div class="title" style="margin-top:8px">Org.nr</div><input id="c_org" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div class="title" style="margin-top:8px">Kontaktperson</div><input id="c_kontakt" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div class="title" style="margin-top:8px">E-post</div><input id="c_email" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div class="title" style="margin-top:8px">Telefon</div><input id="c_tel" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div class="title" style="margin-top:8px">Adress</div><input id="c_addr" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div class="title" style="margin-top:8px">Stad</div><input id="c_stad" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div class="title" style="margin-top:8px">Notering</div><input id="c_note" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div style="margin-top:12px"><button class="btn" onclick="saveCustomer()">Spara</button></div>
  `);
}
function saveCustomer(){
  const id='C'+String(100+DATA.customers.length);
  const c={ id, namn:$('#c_namn').value, kontakt:$('#c_kontakt').value, email:$('#c_email').value, tel:$('#c_tel').value, stad:$('#c_stad').value, notis:$('#c_note').value };
  DATA.customers.push(c); store.set('customers', DATA.customers);
  closeSheet(); router();
}
function editCustomer(id){
  alert('Mock: redigering kommer i n√§sta version.');
}
function deleteCustomer(id){
  if(!confirm('Ta bort kund '+id+'?'))return;
  const i=DATA.customers.findIndex(c=>c.id===id); if(i>-1){ DATA.customers.splice(i,1); store.set('customers',DATA.customers); }
  closeSheet(); router();
}

/* ---------------- Inventory ---------------- */
function renderInventory(root){
  root.innerHTML = `
    <section class="grid">
      <div class="card">
        <div class="subhead"><h3>Inventarie</h3><div><button class="btn" onclick="openNewItem()">+ L√§gg till produkt</button></div></div>
        <div class="table"><table>
          <thead><tr><th>Artikelnummer</th><th>Namn</th><th>Typ</th><th>Antal</th><th>Ink√∂p</th><th>Pris</th><th>Status</th></tr></thead>
          <tbody id="invBody"></tbody>
        </table></div>
      </div>
    </section>
  `;
  const tb=$('#invBody');
  DATA.inventory.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><a href="javascript:void(0)" onclick="openItem('${p.sku}')">${p.sku}</a></td><td>${p.namn}</td><td>${p.typ}</td><td>${p.antal}</td><td>${p.inkop} kr</td><td>${p.pris} kr</td><td><span class="tag">${p.status}</span></td>`;
    tb.appendChild(tr);
  });
}
function openItem(sku){
  const p = DATA.inventory.find(x=>x.sku===sku);
  openSheet('Produkt ‚Äî '+p.namn, `
    <div class="title">Artikel: ${p.sku} ‚Ä¢ Typ: ${p.typ}</div>
    <div class="title">Antal: ${p.antal} ‚Ä¢ Pris: ${p.pris} kr</div>
    <div class="title">Status: ${p.status}</div>
    <hr style="border:none;border-top:1px solid #EEF2F7;margin:12px 0">
    <button class="btn" onclick="alert('Mock: √§ndra i n√§sta version')">√Ñndra</button>
    <button class="btn" onclick="deleteItem('${p.sku}')">Ta bort</button>
    <div class="title" style="margin-top:12px"><strong>AI-tips:</strong> Bristsaldo inom 2 veckor. Rek. ink√∂p 100 st.</div>
  `);
}
function openNewItem(){
  openSheet('Ny produkt', `
    <div class="title">Artikelnummer</div><input id="p_sku" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div class="title" style="margin-top:8px">Namn</div><input id="p_namn" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div class="title" style="margin-top:8px">Typ</div><input id="p_typ" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div class="title" style="margin-top:8px">Antal</div><input id="p_antal" type="number" min="0" value="0" style="width:120px;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div class="title" style="margin-top:8px">Ink√∂pspris</div><input id="p_inkop" type="number" min="0" value="0" style="width:120px;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div class="title" style="margin-top:8px">F√∂rs√§ljningspris</div><input id="p_pris" type="number" min="0" value="0" style="width:120px;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div style="margin-top:12px"><button class="btn" onclick="saveItem()">Spara</button></div>
  `);
}
function saveItem(){
  const p={ sku:$('#p_sku').value, namn:$('#p_namn').value, typ:$('#p_typ').value, antal:parseInt($('#p_antal').value||'0',10), inkop:parseInt($('#p_inkop').value||'0',10), pris:parseInt($('#p_pris').value||'0',10), status:'OK' };
  DATA.inventory.push(p); store.set('inventory', DATA.inventory); closeSheet(); router();
}
function deleteItem(sku){
  if(!confirm('Ta bort '+sku+'?'))return;
  const i=DATA.inventory.findIndex(x=>x.sku===sku); if(i>-1){ DATA.inventory.splice(i,1); store.set('inventory', DATA.inventory); }
  closeSheet(); router();
}

/* ---------------- Employees ---------------- */
function renderEmployees(root){
  root.innerHTML=`
    <section class="grid">
      <div class="card">
        <div class="subhead"><h3>Anst√§llda</h3><div><button class="btn" onclick="openNewEmp()">+ L√§gg till</button></div></div>
        <div class="table"><table>
          <thead><tr><th>ID</th><th>Namn</th><th>Roll</th><th>E-post</th><th>Telefon</th><th>Form</th><th>Start</th></tr></thead>
          <tbody id="empBody"></tbody>
        </table></div>
      </div>
    </section>`;
  const tb=$('#empBody');
  DATA.employees.forEach(e=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><a href="javascript:void(0)" onclick="openEmp('${e.id}')">${e.id}</a></td><td>${e.namn}</td><td>${e.roll}</td><td>${e.email}</td><td>${e.tel}</td><td>${e.form}</td><td>${e.start}</td>`;
    tb.appendChild(tr);
  });
}
function openEmp(id){
  const e=DATA.employees.find(x=>x.id===id);
  openSheet('Anst√§lld ‚Äî '+e.namn, `
    <div class="title">Roll: ${e.roll}</div>
    <div class="title">Kontakt: ${e.email} ‚Ä¢ ${e.tel}</div>
    <div class="title">Anst√§llningsform: ${e.form} ‚Ä¢ Start: ${e.start}</div>
    <hr style="border:none;border-top:1px solid #EEF2F7;margin:12px 0">
    <button class="btn" onclick="alert('Mock: √§ndra i n√§sta version')">√Ñndra</button>
    <button class="btn" onclick="deleteEmp('${e.id}')">Ta bort</button>
  `);
}
function openNewEmp(){
  openSheet('Ny anst√§lld', `
    <div class="title">Namn</div><input id="e_namn" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div class="title" style="margin-top:8px">Roll</div><input id="e_roll" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div class="title" style="margin-top:8px">E-post</div><input id="e_email" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div class="title" style="margin-top:8px">Telefon</div><input id="e_tel" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div class="title" style="margin-top:8px">Adress</div><input id="e_addr" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div class="title" style="margin-top:8px">Anst√§llningsform</div>
    <select id="e_form" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
      <option>Heltid</option><option>Deltid</option><option>Provanst</option>
    </select>
    <div class="title" style="margin-top:8px">Startdatum</div><input id="e_start" type="date" style="padding:10px;border:1px solid var(--border);border-radius:10px">
    <div style="margin-top:12px"><button class="btn" onclick="saveEmp()">Spara</button></div>
  `);
}
function saveEmp(){
  const e={ id:'E'+String(100+DATA.employees.length), namn:$('#e_namn').value, roll:$('#e_roll').value, email:$('#e_email').value, tel:$('#e_tel').value, form:$('#e_form').value, start:$('#e_start').value };
  DATA.employees.push(e); store.set('employees',DATA.employees); closeSheet(); router();
}
function deleteEmp(id){
  if(!confirm('Ta bort '+id+'?'))return;
  const i=DATA.employees.findIndex(x=>x.id===id); if(i>-1){ DATA.employees.splice(i,1); store.set('employees',DATA.employees); }
  closeSheet(); router();
}

/* ---------------- Files ---------------- */
function renderFiles(root){
  root.innerHTML=`
    <section class="grid">
      <div class="card">
        <div class="subhead"><h3>Filer & kvitton</h3><div><button class="btn" onclick="openUpload()">+ Ladda upp</button></div></div>
        <div class="table"><table>
          <thead><tr><th>Fil</th><th>Tagg</th><th>√Ötg√§rd</th></tr></thead>
          <tbody id="fileBody"></tbody>
        </table></div>
      </div>
    </section>`;
  const tb=$('#fileBody');
  DATA.files.forEach(f=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${f.namn}</td><td><span class="tag">${f.tag}</span></td><td><button class="btn" onclick="openFileNote('${f.id}')">Notering</button></td>`;
    tb.appendChild(tr);
  });
}
function openUpload(){
  openSheet('Ladda upp (mock)', `
    <p class="title">V√§lj fil och tagg (mock)</p>
    <button class="btn" onclick="alert('Mock upload klar')">Ladda upp</button>
  `);
}
function openFileNote(id){
  openSheet('Notering f√∂r fil '+id, `
    <div class="title">L√§gg notering & v√§lj mottagare</div>
    <input id="f_note" placeholder="Notering‚Ä¶" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div style="margin-top:8px"><label><input type="checkbox" id="to_eco"> Skicka till ekonomi</label></div>
    <div style="margin-top:10px"><button class="btn" onclick="alert('Sparat (mock)')">Spara</button></div>
  `);
}

/* ---------------- Map ---------------- */
let mapMini, miniMarker;
function initMapMini(){
  setTimeout(()=>{
    mapMini = L.map('mapMini');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(mapMini);
    locateUser(mapMini, true);
  },10);
}
function renderMapPage(root){
  root.innerHTML = `
    <section class="grid">
      <div class="card">
        <div class="subhead"><h3>AI-karta ‚Äî Sales Route Planner</h3>
          <div>
            <button class="btn" onclick="askAiRoute()">‚ú® Ask AI</button>
            <button class="btn" onclick="addPlaceNote()">+ Notis p√• plats</button>
          </div>
        </div>
        <div id="mapBig"></div>
        <div class="title" style="margin-top:8px">AI f√∂resl√•r: Elon Kista ‚Üí Power Solna ‚Üí Mekonomen Bromma</div>
      </div>
    </section>
  `;
  setTimeout(()=>{
    const m = L.map('mapBig');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(m);
    locateUser(m, false);
    // mock markers
    L.marker([59.403,17.95]).addTo(m).bindPopup('Elon Kista');
    L.marker([59.365,18.004]).addTo(m).bindPopup('Power Solna');
    L.marker([59.354,17.939]).addTo(m).bindPopup('Mekonomen Bromma');
  },10);
}
function locateUser(map, mini){
  function place(lat,lng){
    map.setView([lat,lng], mini?12:11);
    const mk = L.marker([lat,lng]).addTo(map).bindPopup('Du √§r h√§r');
    if(mini) miniMarker = mk;
  }
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=> place(pos.coords.latitude,pos.coords.longitude), ()=> place(59.334591,18.063240));
  }else{ place(59.334591,18.063240); }
}
function askAiRoute(){
  openSheet('AI-rutt ‚Äî rekommendation', `
    <ol>
      <li>Elon Kista ‚Äî l√§gg notis: ‚Äúvill k√∂pa om 20 dagar‚Äù.</li>
      <li>Power Solna</li>
      <li>Mekonomen Bromma</li>
    </ol>
    <div class="title">Export till Google Maps kommer i n√§sta version.</div>
  `);
}
function addPlaceNote(){
  openSheet('Platsnotis', `
    <div class="title">Butik/Plats</div><input id="place_name" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
    <div class="title" style="margin-top:8px">Notis</div><input id="place_note" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px" value="vill k√∂pa om 20 dagar">
    <div style="margin-top:10px"><button class="btn" onclick="savePlaceNote()">Spara</button></div>
  `);
}
function savePlaceNote(){
  const n = $('#place_name').value || 'Ok√§nd plats';
  const t = $('#place_note').value || '';
  DATA.notis.unshift('üìç '+n+ (t?(' ‚Äî '+t):''));
  store.set('notis', DATA.notis);
  closeSheet(); router();
}

/* ---------------- Chat (page) ---------------- */
function renderChatPage(root){
  root.innerHTML = `
    <section class="grid">
      <div class="card">
        <div class="subhead"><h3>Intern chatt</h3></div>
        <div id="chatFull" style="max-height:420px;overflow:auto"></div>
        <div style="display:flex; gap:8px; margin-top:8px">
          <input id="chatFullInput" placeholder="Skriv‚Ä¶ (Enter skickar)" style="flex:1;border:1px solid var(--border);border-radius:10px;padding:10px 12px">
          <button class="btn" onclick="chatFullSend()">Skicka</button>
        </div>
      </div>
    </section>
  `;
  renderChatList('#chatFull');
  $('#chatFullInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); chatFullSend(); }});
}

/* ---------------- Settings ---------------- */
function renderSettings(root){
  const s = DATA.settings;
  root.innerHTML = `
    <section class="grid">
      <div class="card">
        <div class="subhead"><h3>Inst√§llningar</h3></div>
        <div class="row2">
          <div>
            <div class="title">Tema</div>
            <select id="set_theme" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
              <option value="light" ${s.theme==='light'?'selected':''}>Ljust</option>
              <option value="dark" disabled>M√∂rkt (senare)</option>
            </select>
          </div>
          <div>
            <div class="title">Spr√•k</div>
            <select id="set_lang" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px">
              <option value="sv" ${s.lang==='sv'?'selected':''}>Svenska</option>
              <option value="en">English</option>
              <option value="th">‡πÑ‡∏ó‡∏¢</option>
            </select>
          </div>
        </div>
        <hr style="border:none;border-top:1px solid #EEF2F7;margin:12px 0">
        <div class="title">F√∂retagsuppgifter</div>
        <input id="co_name" value="${s.company.namn}" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;margin:6px 0">
        <input id="co_org" value="${s.company.orgnr}" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;margin:6px 0">
        <input id="co_addr" value="${s.company.addr}" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;margin:6px 0">
        <input id="co_email" value="${s.company.email}" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;margin:6px 0">
        <hr style="border:none;border-top:1px solid #EEF2F7;margin:12px 0">
        <div class="title">API-nycklar (placeholders)</div>
        <input id="api_frakt" placeholder="Fraktjakt" value="${s.api.fraktjakt}" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;margin:6px 0">
        <input id="api_finans" placeholder="Finansbolag" value="${s.api.finans}" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;margin:6px 0">
        <input id="api_wa" placeholder="WhatsApp" value="${s.api.whatsapp}" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;margin:6px 0">
        <input id="api_sms" placeholder="SMS" value="${s.api.sms}" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;margin:6px 0">
        <div style="margin-top:12px"><button class="btn" onclick="saveSettings()">Spara</button></div>
      </div>
    </section>
  `;
}
function saveSettings(){
  DATA.settings = {
    theme:$('#set_theme').value, lang:$('#set_lang').value,
    company:{ namn:$('#co_name').value, orgnr:$('#co_org').value, addr:$('#co_addr').value, email:$('#co_email').value },
    api:{ fraktjakt:$('#api_frakt').value, finans:$('#api_finans').value, whatsapp:$('#api_wa').value, sms:$('#api_sms').value, ai_engine:DATA.settings.api.ai_engine }
  };
  store.set('settings', DATA.settings);
  alert('Sparat.');
}

/* ---------------- Notiser ---------------- */
function openNotis(){
  openSheet('Notiser', `
    <ul style="margin:0;padding-left:18px">${DATA.notis.map(n=>`<li>${n}</li>`).join('')}</ul>
  `);
}
function renderNotis(sel){
  const ul=document.querySelector(sel); ul.innerHTML='';
  DATA.notis.forEach(n=>{ const li=document.createElement('li'); li.textContent=n; ul.appendChild(li); });
  $('#notisCount')?.textContent = DATA.notis.length;
  $('#notisCount') && ($('#notisCount').textContent = DATA.notis.length);
  $('#notisCount') && ($('#notisCount').textContent = DATA.notis.length);
  $('#notisCount')?.textContent;
  $('#notisCount') && ($('#notisCount').textContent = DATA.notis.length);
  $('#notisCount') && ($('#notisCount').textContent = DATA.notis.length);
  // topbar badge
  $('#notisCountTop') && ($('#notisCountTop').textContent = DATA.notis.length);
  $('#notisCountTop')?.textContent;
  $('#notisCountTop') && ($('#notisCountTop').textContent = DATA.notis.length);
  $('#notisCountTop') && ($('#notisCountTop').textContent = DATA.notis.length);
  $('#notisCountTop');
  $('#notisCountTop');
  $('#notisCountTop');
  $('#notisCountTop');
  // sidebar bell
  $('#notisCount') && ($('#notisCount').textContent = DATA.notis.length);
  $('#notisCountTop') && ($('#notisCountTop').textContent = DATA.notis.length);
  $('#notisCountTop');
  $('#notisCountTop');
  // also update topbar icon
  $('#notisCountTop');
  // (simplify) update visible topbar badge:
  $('#notisCount')?.textContent;
  // update little badge:
  $('#notisCountTop');
  $('#notisCountTop');
  // fallback: fixed bell near topbar
  $('#notisCountTop');
  // set number in top-right bell
  $('#notisCountTop');
  // set visible count:
  $('#notisCountTop');
  // just set the one existing in this layout:
  $('#notisCount').textContent = DATA.notis.length;
}

/* ---------------- Chat (widget + page reuse) ---------------- */
const CHAT = store.get('chat', [
  {me:false, text:'Hej! Hur kan jag hj√§lpa dig idag?'},
  {me:true, text:'Visa dagens order.'}
]);
function renderChatList(sel){
  const box = document.querySelector(sel); box.innerHTML='';
  CHAT.forEach(m=>{
    const b=document.createElement('div'); b.className='msg '+(m.me?'me':'ai'); b.textContent=m.text; box.appendChild(b);
  });
  box.scrollTop = box.scrollHeight;
}
function renderDashChat(){
  renderChatList('#dashChat');
}
function sendChat(){
  const inp = $('#chatInput'); const t=inp.value.trim(); if(!t) return;
  CHAT.push({me:true, text:t}); store.set('chat', CHAT);
  renderChatList('#chatMsgs');
  inp.value=''; setTimeout(()=>{ CHAT.push({me:false, text:aiReply(t)}); store.set('chat', CHAT); renderChatList('#chatMsgs'); }, 500);
}
function dashChatSend(){
  const inp = $('#dashChatInput'); const t=inp.value.trim(); if(!t) return;
  CHAT.push({me:true, text:t}); store.set('chat', CHAT);
  renderChatList('#dashChat');
  inp.value=''; setTimeout(()=>{ CHAT.push({me:false, text:aiReply(t)}); store.set('chat', CHAT); renderChatList('#dashChat'); }, 500);
}
function chatFullSend(){
  const inp = $('#chatFullInput'); const t=inp.value.trim(); if(!t) return;
  CHAT.push({me:true, text:t}); store.set('chat', CHAT);
  renderChatList('#chatFull');
  inp.value=''; setTimeout(()=>{ CHAT.push({me:false, text:aiReply(t)}); store.set('chat', CHAT); renderChatList('#chatFull'); }, 500);
}
function aiReply(txt){
  const l = txt.toLowerCase();
  if(l.includes('budget')) return 'AI: Budget stabil. F√∂rslag: +5% marknadsbudget kommande vecka.';
  if(l.includes('rutt')||l.includes('karta')) return 'AI: Elon Kista ‚Üí Power Solna ‚Üí Mekonomen Bromma (43 min).';
  if(l.includes('order')) return 'AI: Dagens ordrar: #10234 (24 900 kr), #10231 (12 200 kr).';
  return 'AI: Noterat. Vill du att jag skapar en p√•minnelse eller uppgift?';
}

/* ---------------- Overlay Sheet ---------------- */
function openSheet(title, html){
  $('#sheetTitle').textContent = title;
  $('#sheetBody').innerHTML = html;
  $('#overlay').style.display='flex';
}
function closeSheet(){ $('#overlay').style.display='none'; }
function openEcoDetail(){
  openSheet('Ekonomi ‚Äî detaljer', `<div style="height:420px"><canvas id="ecoChartBig"></canvas></div>
    <div class="title" style="margin-top:8px"><strong>AI-tips:</strong> Kostnaderna avviker i vecka 42. F√∂resl√•r samtal med leverant√∂r.</div>`);
  const ctx2 = document.getElementById('ecoChartBig');
  new Chart(ctx2,{ type:'bar', data:{ labels:['v1','v2','v3','v4','v5'],
    datasets:[
      {label:'Oms√§ttning', data:[100,140,90,130,160], backgroundColor:'#CFEAFF', borderRadius:8},
      {label:'Kostnader', data:[40,65,45,60,70], backgroundColor:'#FEE2E2', borderRadius:8},
      {label:'Brutto%', data:[40,42,40,41,42], type:'line', yAxisID:'y1', borderColor:'#3B82F6', tension:.3, pointRadius:0}
    ]}, options:{ maintainAspectRatio:false, scales:{ y1:{position:'right', ticks:{callback:v=>v+'%'}} } }
  });
}
function openChatDetail(){
  openSheet('Teamchatt ‚Äî helsk√§rm', `<div id="chatFull2" style="max-height:420px;overflow:auto"></div>`);
  renderChatList('#chatFull2');
}
function openMapDetail(){
  openSheet('AI-karta ‚Äî helsk√§rm', `<div id="mapBig" style="height:420px;border-radius:12px;border:1px solid var(--border)"></div>`);
  setTimeout(()=>{
    const m=L.map('mapBig'); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(m);
    locateUser(m,false);
    L.marker([59.403,17.95]).addTo(m).bindPopup('Elon Kista');
    L.marker([59.365,18.004]).addTo(m).bindPopup('Power Solna');
    L.marker([59.354,17.939]).addTo(m).bindPopup('Mekonomen Bromma');
  },10);
}
function openCoachDetail(){
  openSheet('AI-Coach ‚Äî detalj', `
    <p class="title">Jag kan sammanfatta veckan, bevaka deadlines, och varna f√∂r l√•g lagerniv√•.</p>
    <div style="display:flex; gap:8px"><button class="btn" onclick="alert('Mock: Veckorapport skapad')">Skapa veckorapport</button>
    <button class="btn" onclick="alert('Mock: P√•minnelse satt')">S√§tt p√•minnelse</button></div>
  `);
}

/* ---------------- Util ---------------- */
function fmtKr(n){ return n.toLocaleString('sv-SE')+' kr'; }

/* ---------------- Boot ---------------- */
renderChatList('#chatMsgs'); // floating widget

</script>
</body>
</html>
